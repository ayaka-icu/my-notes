## åˆ†å¸ƒå¼äº‹åŠ¡



### ç®€è¿°





#### æœ¬åœ°äº‹åŠ¡

æœ¬åœ°äº‹åŠ¡ï¼Œä¹Ÿå°±æ˜¯ä¼ ç»Ÿçš„**å•æœºäº‹åŠ¡**ã€‚åœ¨ä¼ ç»Ÿæ•°æ®åº“äº‹åŠ¡ä¸­ï¼Œå¿…é¡»è¦æ»¡è¶³å››ä¸ªåŸåˆ™ï¼š

![image-20210724165045186](../assets/md-img/åˆ†å¸ƒå¼ç¼“å­˜.assets/image-20210724165045186.png)







#### åˆ†å¸ƒå¼äº‹åŠ¡

**åˆ†å¸ƒå¼äº‹åŠ¡**ï¼Œå°±æ˜¯æŒ‡ä¸æ˜¯åœ¨å•ä¸ªæœåŠ¡æˆ–å•ä¸ªæ•°æ®åº“æ¶æ„ä¸‹ï¼Œäº§ç”Ÿçš„äº‹åŠ¡ï¼Œä¾‹å¦‚ï¼š

- è·¨æ•°æ®æºçš„åˆ†å¸ƒå¼äº‹åŠ¡
- è·¨æœåŠ¡çš„åˆ†å¸ƒå¼äº‹åŠ¡
- ç»¼åˆæƒ…å†µ



åœ¨æ•°æ®åº“æ°´å¹³æ‹†åˆ†ã€æœåŠ¡å‚ç›´æ‹†åˆ†ä¹‹åï¼Œä¸€ä¸ªä¸šåŠ¡æ“ä½œé€šå¸¸è¦è·¨å¤šä¸ªæ•°æ®åº“ã€æœåŠ¡æ‰èƒ½å®Œæˆã€‚ä¾‹å¦‚ç”µå•†è¡Œä¸šä¸­æ¯”è¾ƒå¸¸è§çš„ä¸‹å•ä»˜æ¬¾æ¡ˆä¾‹ï¼ŒåŒ…æ‹¬ä¸‹é¢å‡ ä¸ªè¡Œä¸ºï¼š

- åˆ›å»ºæ–°è®¢å•
- æ‰£å‡å•†å“åº“å­˜
- ä»ç”¨æˆ·è´¦æˆ·ä½™é¢æ‰£é™¤é‡‘é¢



å®Œæˆä¸Šé¢çš„æ“ä½œéœ€è¦è®¿é—®ä¸‰ä¸ªä¸åŒçš„å¾®æœåŠ¡å’Œä¸‰ä¸ªä¸åŒçš„æ•°æ®åº“ã€‚

![image-20210724165338958](../assets/md-img/åˆ†å¸ƒå¼ç¼“å­˜.assets/image-20210724165338958.png)



è®¢å•çš„åˆ›å»ºã€åº“å­˜çš„æ‰£å‡ã€è´¦æˆ·æ‰£æ¬¾åœ¨æ¯ä¸€ä¸ªæœåŠ¡å’Œæ•°æ®åº“å†…æ˜¯ä¸€ä¸ªæœ¬åœ°äº‹åŠ¡ï¼Œå¯ä»¥ä¿è¯ACIDåŸåˆ™ã€‚

ä½†æ˜¯å½“æˆ‘ä»¬æŠŠä¸‰ä»¶äº‹æƒ…çœ‹åšä¸€ä¸ª"ä¸šåŠ¡"ï¼Œè¦æ»¡è¶³ä¿è¯â€œä¸šåŠ¡â€çš„åŸå­æ€§ï¼Œè¦ä¹ˆæ‰€æœ‰æ“ä½œå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ï¼Œä¸å…è®¸å‡ºç°éƒ¨åˆ†æˆåŠŸéƒ¨åˆ†å¤±è´¥çš„ç°è±¡ï¼Œè¿™å°±æ˜¯**åˆ†å¸ƒå¼ç³»ç»Ÿä¸‹çš„äº‹åŠ¡**äº†ã€‚

æ­¤æ—¶ACIDéš¾ä»¥æ»¡è¶³ï¼Œè¿™æ˜¯åˆ†å¸ƒå¼äº‹åŠ¡è¦è§£å†³çš„é—®é¢˜ã€‚





**åˆ†å¸ƒå¼æœåŠ¡çš„äº‹åŠ¡é—®é¢˜**

åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸‹ï¼Œä¸€ä¸ªä¸šåŠ¡è·¨è¶Šå¤šä¸ªæœåŠ¡æˆ–æ•°æ®æºï¼Œæ¯ä¸ªæœåŠ¡éƒ½æ˜¯ä¸€ä¸ªåˆ†æ”¯äº‹åŠ¡ï¼Œè¦ä¿è¯æ‰€æœ‰åˆ†æ”¯äº‹åŠ¡æœ€ç»ˆçŠ¶æ€ä¸€è‡´ ï¼Œè¿™æ ·çš„äº‹åŠ¡å°±æ˜¯åˆ†å¸ƒå¼äº‹åŠ¡ã€‚

![image-20230311200306408](../assets/md-img/åˆ†å¸ƒå¼ç¼“å­˜.assets/image-20230311200306408.png)









### ç†è®ºåŸºç¡€



![image-20230311200401946](../assets/md-img/åˆ†å¸ƒå¼ç¼“å­˜.assets/image-20230311200401946.png)





#### CAPå®šç†

 1998å¹´ï¼ŒåŠ å·å¤§å­¦çš„è®¡ç®—æœºç§‘å­¦å®¶ Eric Brewer æå‡ºï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿæœ‰ä¸‰ä¸ªæŒ‡æ ‡ï¼š 

- **Consistencyï¼ˆä¸€è‡´æ€§ï¼‰**

- **Availabilityï¼ˆå¯ç”¨æ€§ï¼‰**

- **Partition tolerance ï¼ˆåˆ†åŒºå®¹é”™æ€§ï¼‰**



Eric Brewer è¯´ï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿæ— æ³•åŒæ—¶æ»¡è¶³è¿™ä¸‰ä¸ªæŒ‡æ ‡ã€‚ è¿™ä¸ªç»“è®ºå°±å«åš CAP å®šç†ã€‚

![image-20230311200613390](../assets/md-img/åˆ†å¸ƒå¼ç¼“å­˜.assets/image-20230311200613390.png)







**Consistencyï¼ˆä¸€è‡´æ€§ï¼‰**

![image-20230311200613390](../assets/md-img/åˆ†å¸ƒå¼ç¼“å­˜.assets/image-20230311200724875.png)



**Availabilityï¼ˆå¯ç”¨æ€§ï¼‰**

![image-20230311201138077](../assets/md-img/åˆ†å¸ƒå¼ç¼“å­˜.assets/image-20230311201138077.png)



**Partition tolerance ï¼ˆåˆ†åŒºå®¹é”™æ€§ï¼‰**

![image-20230311201207714](../assets/md-img/åˆ†å¸ƒå¼ç¼“å­˜.assets/image-20230311201207714.png)





ç®€è¿°CAPå®šç†å†…å®¹ï¼Ÿ 

- **åˆ†å¸ƒå¼ç³»ç»ŸèŠ‚ç‚¹é€šè¿‡ç½‘ç»œè¿æ¥ï¼Œä¸€å®šä¼šå‡ºç°åˆ†åŒºé—®é¢˜ï¼ˆPï¼‰**
- å½“åˆ†åŒºå‡ºç°æ—¶ï¼Œç³»ç»Ÿçš„ä¸€è‡´æ€§ï¼ˆ**C**ï¼‰å’Œå¯ç”¨æ€§ï¼ˆ**A**ï¼‰å°±æ— æ³• åŒæ—¶æ»¡è¶³ 



æ€è€ƒï¼šelasticsearché›†ç¾¤æ˜¯CPè¿˜æ˜¯APï¼Ÿ 

- ESé›†ç¾¤å‡ºç°åˆ†åŒºæ—¶ï¼Œæ•…éšœèŠ‚ç‚¹ä¼šè¢«å‰”é™¤é›†ç¾¤ï¼Œæ•°æ®åˆ†ç‰‡ä¼š é‡æ–°åˆ†é…åˆ°å…¶å®ƒèŠ‚ç‚¹ï¼Œä¿è¯æ•°æ®ä¸€è‡´ã€‚
- å› æ­¤æ˜¯ä½å¯ç”¨æ€§ï¼Œé«˜ä¸€è‡´æ€§ï¼Œå±äºCP







#### BASEç†è®º 

BASEç†è®ºæ˜¯å¯¹CAPçš„ä¸€ç§è§£å†³æ€è·¯ï¼ŒåŒ…å«ä¸‰ä¸ªæ€æƒ³ï¼š 

- BA[**åŸºæœ¬å¯ç”¨**]ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿåœ¨å‡ºç°æ•…éšœæ—¶ï¼Œå…è®¸æŸå¤±éƒ¨åˆ†å¯ç”¨æ€§ï¼Œå³ä¿è¯æ ¸å¿ƒå¯ç”¨ã€‚
- S [**è½¯çŠ¶æ€**]ï¼šåœ¨ä¸€å®šæ—¶é—´å†…ï¼Œå…è®¸å‡ºç°ä¸­é—´çŠ¶æ€ï¼Œæ¯”å¦‚ä¸´æ—¶çš„ä¸ä¸€è‡´çŠ¶æ€ã€‚
- E [**æœ€ç»ˆä¸€è‡´æ€§**]ï¼šè™½ç„¶æ— æ³•ä¿è¯å¼ºä¸€è‡´æ€§ï¼Œä½†æ˜¯åœ¨è½¯çŠ¶æ€ç»“æŸåï¼Œæœ€ç»ˆè¾¾åˆ°æ•°æ®ä¸€è‡´ã€‚ 



|          è¯           |     æ„     |
| :-------------------: | :--------: |
|  Basically Available  |  åŸºæœ¬å¯ç”¨  |
|      Soft State       |   è½¯çŠ¶æ€   |
| Eventually Consistent | æœ€ç»ˆä¸€è‡´æ€§ |



è€Œåˆ†å¸ƒå¼äº‹åŠ¡æœ€å¤§çš„é—®é¢˜æ˜¯å„ä¸ªå­äº‹åŠ¡çš„ä¸€è‡´æ€§é—®é¢˜ï¼Œå› æ­¤å¯ä»¥å€Ÿé‰´CAPå®šç†å’ŒBASEç†è®ºï¼š

- **APæ¨¡å¼ï¼š**å„å­äº‹åŠ¡åˆ†åˆ«æ‰§è¡Œå’Œæäº¤ï¼Œå…è®¸å‡ºç°ç»“æœä¸ä¸€è‡´ï¼Œç„¶åé‡‡ç”¨å¼¥è¡¥æªæ–½æ¢å¤æ•°æ®å³å¯ï¼Œ**å®ç°æœ€ç»ˆä¸€è‡´**ã€‚
- **CPæ¨¡å¼ï¼š**å„ä¸ªå­äº‹åŠ¡æ‰§è¡Œåäº’ç›¸ç­‰å¾…ï¼ŒåŒæ—¶æäº¤ï¼ŒåŒæ—¶å›æ»šï¼Œè¾¾æˆ**å¼ºä¸€è‡´**ã€‚ä½†äº‹åŠ¡ç­‰å¾…è¿‡ç¨‹ä¸­ï¼Œå¤„äº**å¼±å¯ç”¨çŠ¶æ€**ã€‚







#### åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹

è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œå„ä¸ªå­ç³»ç»Ÿä¹‹é—´å¿…é¡»èƒ½æ„ŸçŸ¥åˆ°å½¼æ­¤çš„äº‹åŠ¡çŠ¶æ€ï¼Œæ‰èƒ½ä¿è¯çŠ¶æ€ä¸€è‡´ï¼Œ

å› æ­¤éœ€è¦ä¸€ä¸ªäº‹åŠ¡åè°ƒè€…æ¥åè°ƒæ¯ä¸€ä¸ªäº‹åŠ¡çš„å‚ä¸è€…ï¼ˆå­ç³»ç»Ÿäº‹åŠ¡ï¼‰ã€‚

è¿™é‡Œçš„å­ç³»ç»Ÿäº‹åŠ¡ï¼Œç§°ä¸º**åˆ†æ”¯äº‹åŠ¡**ï¼›æœ‰å…³è”çš„å„ä¸ªåˆ†æ”¯äº‹åŠ¡åœ¨ä¸€èµ·ç§°ä¸º**å…¨å±€äº‹åŠ¡**

![image-20230311202345432](../assets/md-img/åˆ†å¸ƒå¼ç¼“å­˜.assets/image-20230311202345432.png)







ç®€è¿°BASEç†è®ºä¸‰ä¸ªæ€æƒ³ï¼š 

- **åŸºæœ¬å¯ç”¨** â€¢ **è½¯çŠ¶æ€** â€¢ **æœ€ç»ˆä¸€è‡´**



è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡çš„æ€æƒ³å’Œæ¨¡å‹ï¼š 

- **å…¨å±€äº‹åŠ¡**ï¼šæ•´ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡ 
- **åˆ†æ”¯äº‹åŠ¡**ï¼šåˆ†å¸ƒå¼äº‹åŠ¡ä¸­åŒ…å«çš„æ¯ä¸ªå­ç³»ç»Ÿçš„äº‹åŠ¡ 
- **æœ€ç»ˆä¸€è‡´æ€æƒ³**ï¼šå„åˆ†æ”¯äº‹åŠ¡åˆ†åˆ«æ‰§è¡Œå¹¶æäº¤ï¼Œå¦‚æœæœ‰ä¸ä¸€è‡´ çš„æƒ…å†µï¼Œå†æƒ³åŠæ³•æ¢å¤æ•°æ®
- **å¼ºä¸€è‡´æ€æƒ³**ï¼šå„åˆ†æ”¯äº‹åŠ¡æ‰§è¡Œå®Œä¸šåŠ¡ä¸è¦æäº¤ï¼Œç­‰å¾…å½¼æ­¤ç»“ æœã€‚è€Œåç»Ÿä¸€æäº¤æˆ–å›æ»š









### Seataæ¡†æ¶



#### ğŸ”–Seataä»‹ç»

Seataæ˜¯2019å¹´1æœˆä»½èš‚èšé‡‘æœå’Œé˜¿é‡Œå·´å·´å…±åŒå¼€æºçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆã€‚è‡´åŠ›äºæä¾›é«˜æ€§èƒ½å’Œç®€å•æ˜“ç”¨çš„åˆ†å¸ƒå¼ äº‹åŠ¡æœåŠ¡ï¼Œä¸ºç”¨æˆ·æ‰“é€ ä¸€ç«™å¼çš„åˆ†å¸ƒå¼è§£å†³æ–¹æ¡ˆã€‚ 

å®˜ç½‘åœ°å€ï¼šhttp://seata.io/ï¼Œå…¶ä¸­çš„æ–‡æ¡£ã€æ’­å®¢ä¸­æä¾›äº†å¤§é‡çš„ä½¿ç”¨è¯´æ˜ã€æºç åˆ†æã€‚





#### ğŸ”–Seataæ¶æ„

Seataäº‹åŠ¡ç®¡ç†ä¸­æœ‰ä¸‰ä¸ªé‡è¦çš„è§’è‰²ï¼š

- **TC - äº‹åŠ¡åè°ƒè€…**ï¼šç»´æŠ¤å…¨å±€å’Œåˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€ï¼Œåè°ƒå…¨å±€äº‹åŠ¡æäº¤æˆ–å›æ»šã€‚
- **TM - äº‹åŠ¡ç®¡ç†å™¨**ï¼šå®šä¹‰å…¨å±€äº‹åŠ¡çš„èŒƒå›´ã€å¼€å§‹å…¨å±€äº‹åŠ¡ã€æäº¤æˆ–å›æ»šå…¨å±€äº‹åŠ¡ã€‚
- **RM - èµ„æºç®¡ç†å™¨**ï¼šç®¡ç†åˆ†æ”¯äº‹åŠ¡å¤„ç†çš„èµ„æºï¼Œä¸TCäº¤è°ˆä»¥æ³¨å†Œåˆ†æ”¯äº‹åŠ¡å’ŒæŠ¥å‘Šåˆ†æ”¯äº‹åŠ¡ çš„çŠ¶æ€ï¼Œå¹¶é©±åŠ¨åˆ†æ”¯äº‹åŠ¡æäº¤æˆ–å›æ»š



![image-20230311203012810](../assets/md-img/åˆ†å¸ƒå¼ç¼“å­˜.assets/image-20230311203012810.png)



|           è¯            |   ç®€   |       æ„       |
| :---------------------: | :----: | :------------: |
| Transaction Coordinator | **TC** | **äº‹åŠ¡åè°ƒè€…** |
|   Transaction Manager   | **TM** | **äº‹åŠ¡ç®¡ç†å™¨** |
|    Resource Manager     | **RM** | **èµ„æºç®¡ç†å™¨** |







#### ğŸ”–Seataéƒ¨ç½²



é¦–å…ˆæˆ‘ä»¬è¦ä¸‹è½½`seata-server`åŒ…ï¼Œåœ°å€åœ¨[http](http://seata.io/zh-cn/blog/download.html)[://seata.io/zh-cn/blog/download](http://seata.io/zh-cn/blog/download.html)[.](http://seata.io/zh-cn/blog/download.html)[html](http://seata.io/zh-cn/blog/download.html) 

åœ¨éä¸­æ–‡ç›®å½•è§£å‹ç¼©è¿™ä¸ª`zip`åŒ…ï¼Œå…¶ç›®å½•ç»“æ„å¦‚ä¸‹

ä¿®æ”¹confç›®å½•ä¸‹çš„`registry.conf`æ–‡ä»¶ï¼Œæ–°ç‰ˆæœ¬æ˜¯`application.yaml`

`registry.conf`:

```yaml
registry {
  # tcæœåŠ¡çš„æ³¨å†Œä¸­å¿ƒç±»ï¼Œè¿™é‡Œé€‰æ‹©nacosï¼Œä¹Ÿå¯ä»¥æ˜¯eurekaã€zookeeperç­‰
  type = "nacos"

  nacos {
    # seata tc æœåŠ¡æ³¨å†Œåˆ° nacosçš„æœåŠ¡åç§°ï¼Œå¯ä»¥è‡ªå®šä¹‰
    application = "seata-tc-server"
    serverAddr = "127.0.0.1:8848"
    group = "DEFAULT_GROUP"
    namespace = ""
    cluster = "SH"
    username = "nacos"
    password = "nacos"
  }
}

config {
  # è¯»å–tcæœåŠ¡ç«¯çš„é…ç½®æ–‡ä»¶çš„æ–¹å¼ï¼Œè¿™é‡Œæ˜¯ä»nacosé…ç½®ä¸­å¿ƒè¯»å–ï¼Œè¿™æ ·å¦‚æœtcæ˜¯é›†ç¾¤ï¼Œå¯ä»¥å…±äº«é…ç½®
  type = "nacos"
  # é…ç½®nacosåœ°å€ç­‰ä¿¡æ¯
  nacos {
    serverAddr = "127.0.0.1:8848"
    namespace = ""
    group = "SEATA_GROUP"
    username = "nacos"
    password = "nacos"
    dataId = "seataServer.properties"
  }
}
```

`application.yaml`

```yaml
seata:
  # æœåŠ¡æ³¨å†Œä¸­å¿ƒ
  registry:
    # support: nacos ã€ eureka ã€ redis ã€ zk  ã€ consul ã€ etcd3 ã€ sofa
    type: nacos
    # preferred-networks: 30.240.*
    nacos:
      application: seata-tc-server
      server-addr: 127.0.0.1:8848
      group: "DEFAULT_GROUP"
      namespace: ""
      cluster: SH
      username: nacos
      password: nacos
      context-path:
      ##if use MSE Nacos with auth, mutex with username/password attribute
      #access-key:
      #secret-key:

  # é…ç½®ä¸­å¿ƒ
  config:
    # support: nacos ã€ consul ã€ apollo ã€ zk  ã€ etcd3
    type: nacos
    nacos:
      server-addr: 127.0.0.1:8848
      namespace: ""
      group: SEATA_GROUP
      username: nacos
      password: nacos
      context-path:
      ##if use MSE Nacos with auth, mutex with username/password attribute
      #access-key:
      #secret-key:
      data-id: seataServer.properties
  security:
    secretKey: SeataSecretKey0c382ef121d778043159209298fd40bf3850a017
    tokenValidityInMilliseconds: 1800000
    ignore:
      urls: /,/**/*.css,/**/*.js,/**/*.html,/**/*.map,/**/*.svg,/**/*.png,/**/*.ico,/console-fe/public/**,/api/v1/auth/login

```



åœ¨nacosæ·»åŠ é…ç½®

ç‰¹åˆ«æ³¨æ„ï¼Œä¸ºäº†è®©tcæœåŠ¡çš„é›†ç¾¤å¯ä»¥å…±äº«é…ç½®ï¼Œæˆ‘ä»¬é€‰æ‹©äº†nacosä½œä¸ºç»Ÿä¸€é…ç½®ä¸­å¿ƒã€‚å› æ­¤æœåŠ¡ç«¯é…ç½®æ–‡ä»¶seataServer.propertiesæ–‡ä»¶éœ€è¦åœ¨nacosä¸­é…å¥½ã€‚

![image-20230311204924791](../assets/md-img/åˆ†å¸ƒå¼ç¼“å­˜.assets/image-20230311204924791.png)



```properties
# æ•°æ®å­˜å‚¨æ–¹å¼ï¼Œdbä»£è¡¨æ•°æ®åº“
store.mode=db
store.db.datasource=druid
store.db.dbType=mysql
store.db.driverClassName=com.mysql.jdbc.Driver
store.db.url=jdbc:mysql://127.0.0.1:3306/seata?useUnicode=true&rewriteBatchedStatements=true
store.db.user=root
store.db.password=123
store.db.minConn=5
store.db.maxConn=30
store.db.globalTable=global_table
store.db.branchTable=branch_table
store.db.queryLimit=100
store.db.lockTable=lock_table
store.db.maxWait=5000
# äº‹åŠ¡ã€æ—¥å¿—ç­‰é…ç½®
server.recovery.committingRetryPeriod=1000
server.recovery.asynCommittingRetryPeriod=1000
server.recovery.rollbackingRetryPeriod=1000
server.recovery.timeoutRetryPeriod=1000
server.maxCommitRetryTimeout=-1
server.maxRollbackRetryTimeout=-1
server.rollbackRetryTimeoutUnlockEnable=false
server.undo.logSaveDays=7
server.undo.logDeletePeriod=86400000

# å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¼ è¾“æ–¹å¼
transport.serialization=seata
transport.compressor=none
# å…³é—­metricsåŠŸèƒ½ï¼Œæé«˜æ€§èƒ½
metrics.enabled=false
metrics.registryType=compact
metrics.exporterList=prometheus
metrics.exporterPrometheusPort=9898
```

å…¶ä¸­çš„`æ•°æ®åº“åœ°å€`ã€`ç”¨æˆ·å`ã€`å¯†ç `éƒ½éœ€è¦ä¿®æ”¹æˆä½ è‡ªå·±çš„æ•°æ®åº“ä¿¡æ¯ã€‚



**åˆ›å»ºæ•°æ®åº“è¡¨**

ç‰¹åˆ«æ³¨æ„ï¼štcæœåŠ¡åœ¨ç®¡ç†åˆ†å¸ƒå¼äº‹åŠ¡æ—¶ï¼Œéœ€è¦è®°å½•äº‹åŠ¡ç›¸å…³æ•°æ®åˆ°æ•°æ®åº“ä¸­ï¼Œä½ éœ€è¦æå‰åˆ›å»ºå¥½è¿™äº›è¡¨ã€‚

æ–°å»ºä¸€ä¸ªåä¸º`seataçš„æ•°æ®åº“`/`åˆšåˆšé…ç½®çš„åº“`

è¿™äº›è¡¨ä¸»è¦è®°å½•`å…¨å±€äº‹åŠ¡`ã€`åˆ†æ”¯äº‹åŠ¡`ã€`å…¨å±€é”ä¿¡æ¯`ï¼š

```mysql
SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;

-- ----------------------------
-- åˆ†æ”¯äº‹åŠ¡è¡¨
-- ----------------------------
DROP TABLE IF EXISTS `branch_table`;
CREATE TABLE `branch_table`  (
  `branch_id` bigint(20) NOT NULL,
  `xid` varchar(128) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
  `transaction_id` bigint(20) NULL DEFAULT NULL,
  `resource_group_id` varchar(32) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `resource_id` varchar(256) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `branch_type` varchar(8) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `status` tinyint(4) NULL DEFAULT NULL,
  `client_id` varchar(64) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `application_data` varchar(2000) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `gmt_create` datetime(6) NULL DEFAULT NULL,
  `gmt_modified` datetime(6) NULL DEFAULT NULL,
  PRIMARY KEY (`branch_id`) USING BTREE,
  INDEX `idx_xid`(`xid`) USING BTREE
) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = Compact;

-- ----------------------------
-- å…¨å±€äº‹åŠ¡è¡¨
-- ----------------------------
DROP TABLE IF EXISTS `global_table`;
CREATE TABLE `global_table`  (
  `xid` varchar(128) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
  `transaction_id` bigint(20) NULL DEFAULT NULL,
  `status` tinyint(4) NOT NULL,
  `application_id` varchar(32) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `transaction_service_group` varchar(32) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `transaction_name` varchar(128) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `timeout` int(11) NULL DEFAULT NULL,
  `begin_time` bigint(20) NULL DEFAULT NULL,
  `application_data` varchar(2000) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `gmt_create` datetime NULL DEFAULT NULL,
  `gmt_modified` datetime NULL DEFAULT NULL,
  PRIMARY KEY (`xid`) USING BTREE,
  INDEX `idx_gmt_modified_status`(`gmt_modified`, `status`) USING BTREE,
  INDEX `idx_transaction_id`(`transaction_id`) USING BTREE
) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = Compact;

SET FOREIGN_KEY_CHECKS = 1;
```



**å¯åŠ¨TCæœåŠ¡**

è¿›å…¥binç›®å½•ï¼Œè¿è¡Œå…¶ä¸­çš„seata-server.batå³å¯

å¯åŠ¨æˆåŠŸåï¼Œseata-serveråº”è¯¥å·²ç»æ³¨å†Œåˆ°nacosæ³¨å†Œä¸­å¿ƒäº†ã€‚

æ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—®nacosåœ°å€ï¼šhttp://localhost:8848ï¼Œç„¶åè¿›å…¥æœåŠ¡åˆ—è¡¨é¡µé¢ï¼Œå¯ä»¥çœ‹åˆ°seata-tc-serverçš„ä¿¡æ¯ï¼š





#### ğŸ”–Seataæ•´åˆ

**å¾®æœåŠ¡é›†æˆseata**



å¼•å…¥ä¾èµ– `pom.xml`

```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-seata</artifactId>
    <exclusions>
        <!--ç‰ˆæœ¬è¾ƒä½ï¼Œ1.3.0ï¼Œå› æ­¤æ’é™¤-->
        <exclusion>
            <artifactId>seata-spring-boot-starter</artifactId>
            <groupId>io.seata</groupId>
        </exclusion>
    </exclusions>
</dependency>
<!--seata starter é‡‡ç”¨1.4.2ç‰ˆæœ¬-->
<dependency>
    <groupId>io.seata</groupId>
    <artifactId>seata-spring-boot-starter</artifactId>
    <version>${seata.version}</version>
</dependency>
```

ä¿®æ”¹é…ç½®æ–‡ä»¶ `application.yaml`

```yaml
seata:
  registry: # TCæœåŠ¡æ³¨å†Œä¸­å¿ƒçš„é…ç½®ï¼Œå¾®æœåŠ¡æ ¹æ®è¿™äº›ä¿¡æ¯å»æ³¨å†Œä¸­å¿ƒè·å–tcæœåŠ¡åœ°å€
    # å‚è€ƒtcæœåŠ¡è‡ªå·±çš„registry.confä¸­çš„é…ç½®
    type: nacos
    nacos: # tc
      server-addr: 127.0.0.1:8848
      namespace: ""
      group: DEFAULT_GROUP
      application: seata-tc-server # tcæœåŠ¡åœ¨nacosä¸­çš„æœåŠ¡åç§°
      cluster: SH
  tx-service-group: seata-demo # äº‹åŠ¡ç»„ï¼Œæ ¹æ®è¿™ä¸ªè·å–tcæœåŠ¡çš„clusteråç§°
  service:
    vgroup-mapping: # äº‹åŠ¡ç»„ä¸TCæœåŠ¡clusterçš„æ˜ å°„å…³ç³»
      seata-demo: SH
```

**æ³¨æ„ï¼š**

nacosæœåŠ¡åç§°ç»„æˆåŒ…æ‹¬`namespace`+`group`+`serviceName`+`cluster` 

seataå®¢æˆ·ç«¯è·å–`tcçš„cluster`åç§°æ–¹å¼æ˜¯ä»¥`tx-group-service`çš„å€¼ä¸º`keyåˆ°vgroupMapping`ä¸­æŸ¥æ‰¾

![image-20230311205806993](../assets/md-img/åˆ†å¸ƒå¼ç¼“å­˜.assets/image-20230311205806993.png)









#### ğŸ”¢Seataæ¨¡å¼â¤µï¸



#### 1ï¸âƒ£XAæ¨¡å¼



**XAæ¨¡å¼åŸç†**

`XAè§„èŒƒ`æ˜¯ X/Open ç»„ç»‡å®šä¹‰çš„åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†ï¼ˆDTPï¼ŒDistributed Transaction Processingï¼‰æ ‡å‡†ï¼Œ`XAè§„èŒƒ`æè¿°äº†å…¨å±€çš„ `TM`ä¸å±€éƒ¨çš„`RM`ä¹‹é—´çš„æ¥å£ï¼Œå‡ ä¹æ‰€æœ‰ä¸»æµçš„æ•°æ®åº“éƒ½å¯¹`XAè§„èŒƒ`æä¾›äº†æ”¯æŒã€‚



**æˆåŠŸ**![image-20230311210818874](../assets/md-img/åˆ†å¸ƒå¼ç¼“å­˜.assets/image-20230311210818874.png)

**å¤±è´¥**![image-20230311210921104](../assets/md-img/åˆ†å¸ƒå¼ç¼“å­˜.assets/image-20230311210921104.png)

---





**seataçš„XAæ¨¡å¼**

![image-20230311211457115](../assets/md-img/åˆ†å¸ƒå¼ç¼“å­˜.assets/image-20230311211457115.png)

---

![image-20230311212528831](../assets/md-img/åˆ†å¸ƒå¼ç¼“å­˜.assets/image-20230311212528831.png)

---



XAæ¨¡å¼çš„ä¼˜ç‚¹

- äº‹åŠ¡çš„å¼ºä¸€è‡´æ€§ï¼Œæ»¡è¶³ACIDåŸåˆ™ã€‚
- å¸¸ç”¨æ•°æ®åº“éƒ½æ”¯æŒï¼Œå®ç°ç®€å•ï¼Œå¹¶ä¸”æ²¡æœ‰ä»£ç ä¾µå…¥ 

XAæ¨¡å¼çš„ç¼ºç‚¹

- å› ä¸ºä¸€é˜¶æ®µéœ€è¦é”å®šæ•°æ®åº“èµ„æºï¼Œç­‰å¾…äºŒé˜¶æ®µç»“æŸæ‰é‡Šæ”¾ï¼Œæ€§èƒ½è¾ƒå·®
- ä¾èµ–å…³ç³»å‹æ•°æ®åº“å®ç°äº‹åŠ¡



**å®ç°XAæ¨¡å¼**

Seataçš„starterå·²ç»å®Œæˆäº†XAæ¨¡å¼çš„è‡ªåŠ¨è£…é…ï¼Œå®ç°éå¸¸ç®€å•ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š

1. ä¿®æ”¹application.ymlæ–‡ä»¶ï¼ˆæ¯ä¸ªå‚ä¸äº‹åŠ¡çš„å¾®æœåŠ¡ï¼‰ï¼Œå¼€å¯XAæ¨¡å¼ï¼š

```yaml
seata:
  data-source-proxy-mode: XA # å¼€å¯æ•°æ®æºä»£ç†çš„XAæ¨¡å¼
```

2. ç»™å‘èµ·å…¨å±€äº‹åŠ¡çš„å…¥å£æ–¹æ³•æ·»åŠ `@GlobalTransactional`æ³¨è§£ï¼Œæœ¬ä¾‹ä¸­æ˜¯OrderServiceImplä¸­çš„createæ–¹æ³•ï¼š

```java
@Override
@GlobalTransactional
public Long create(Order order) {
	// åˆ›å»ºè®¢å•
	orderMapper.insert(order);
	// æ‰£ä½™é¢ ...ç•¥
	// æ‰£å‡åº“å­˜ ...ç•¥
	return order.getId();
}
```

3. é‡å¯æœåŠ¡å¹¶æµ‹è¯•





---



#### 2ï¸âƒ£ATæ¨¡å¼

**ATæ¨¡å¼åŸç†**

ATæ¨¡å¼åŒæ ·æ˜¯åˆ†é˜¶æ®µæäº¤çš„äº‹åŠ¡æ¨¡å‹ï¼Œä¸è¿‡ç¼ºå¼¥è¡¥äº†XAæ¨¡å‹ä¸­èµ„æºé”å®šå‘¨æœŸè¿‡é•¿çš„ç¼ºé™·ã€‚

**é˜¶æ®µä¸€RMçš„å·¥ä½œ**ï¼š

1. æ³¨å†Œåˆ†æ”¯äº‹åŠ¡
2. è®°å½•undo-logï¼ˆæ•°æ®å¿«ç…§ï¼‰
3. æ‰§è¡Œä¸šåŠ¡sqlå¹¶æäº¤
4. æŠ¥å‘Šäº‹åŠ¡çŠ¶æ€ 

**é˜¶æ®µäºŒæäº¤æ—¶RMçš„å·¥ä½œ**ï¼š

- åˆ é™¤undo-logå³å¯ 

**é˜¶æ®µäºŒå›æ»šæ—¶RMçš„å·¥ä½œ**ï¼š

- æ ¹æ®undo-logæ¢å¤æ•°æ®åˆ°æ›´æ–°å‰

![image-20230311212141324](../assets/md-img/åˆ†å¸ƒå¼ç¼“å­˜.assets/image-20230311212141324.png)

![image-20230311212428736](../assets/md-img/åˆ†å¸ƒå¼ç¼“å­˜.assets/image-20230311212428736.png)

ä¾‹å¦‚ï¼Œä¸€ä¸ªåˆ†æ”¯ä¸šåŠ¡çš„SQLæ˜¯è¿™æ ·çš„ï¼šupdate tb_account set money = money - 10 where id = 1

![image-20230311212835820](../assets/md-img/åˆ†å¸ƒå¼ç¼“å­˜.assets/image-20230311212835820.png)

ATæ¨¡å¼ä¸XAæ¨¡å¼æœ€å¤§çš„åŒºåˆ«

- XAæ¨¡å¼ä¸€é˜¶æ®µä¸æäº¤äº‹åŠ¡ï¼Œé”å®šèµ„æºï¼›ATæ¨¡å¼ä¸€é˜¶æ®µç›´æ¥ æäº¤ï¼Œä¸é”å®šèµ„æºã€‚
- XAæ¨¡å¼ä¾èµ–æ•°æ®åº“æœºåˆ¶å®ç°å›æ»šï¼›ATæ¨¡å¼åˆ©ç”¨æ•°æ®å¿«ç…§å® ç°æ•°æ®å›æ»š
- XAæ¨¡å¼å¼ºä¸€è‡´ï¼›ATæ¨¡å¼æœ€ç»ˆä¸€è‡´





**å‡ºç°è„å†™é—®é¢˜**

![image-20230311213133505](../assets/md-img/åˆ†å¸ƒå¼ç¼“å­˜.assets/image-20230311213133505.png)

**è§£å†³è„å†™é—®é¢˜**

![image-20230311213802206](../assets/md-img/åˆ†å¸ƒå¼ç¼“å­˜.assets/image-20230311213802206.png)





ATæ¨¡å¼çš„ä¼˜ç‚¹ï¼š

- ä¸€é˜¶æ®µå®Œæˆç›´æ¥æäº¤äº‹åŠ¡ï¼Œé‡Šæ”¾æ•°æ®åº“èµ„æºï¼Œæ€§èƒ½æ¯”è¾ƒå¥½ 

- åˆ©ç”¨å…¨å±€é”å®ç°è¯»å†™éš”ç¦» 
- æ²¡æœ‰ä»£ç ä¾µå…¥ï¼Œæ¡†æ¶è‡ªåŠ¨å®Œæˆå›æ»šå’Œæäº¤ 

ATæ¨¡å¼çš„ç¼ºç‚¹ï¼š

- ä¸¤é˜¶æ®µä¹‹é—´å±äºè½¯çŠ¶æ€ï¼Œå±äºæœ€ç»ˆä¸€è‡´
- æ¡†æ¶çš„å¿«ç…§åŠŸèƒ½ä¼šå½±å“æ€§èƒ½ï¼Œä½†æ¯”XAæ¨¡å¼è¦å¥½å¾ˆå¤š





**å®ç°ATæ¨¡å¼**

ATæ¨¡å¼ä¸­çš„å¿«ç…§ç”Ÿæˆã€å›æ»šç­‰åŠ¨ä½œéƒ½æ˜¯ç”±æ¡†æ¶è‡ªåŠ¨å®Œæˆï¼Œæ²¡æœ‰ä»»ä½•ä»£ç ä¾µå…¥ï¼Œå› æ­¤å®ç°éå¸¸ç®€å•ã€‚

ç”±äºéœ€è¦ç”Ÿæˆå¿«ç…§ä¿¡æ¯ï¼ŒATæ¨¡å¼éœ€è¦ä¸¤å¼ æ•°æ®åº“è¡¨``undo_log`å’Œ`lock_table`

`lock_table`å¯¼å…¥åˆ°`TCæœåŠ¡`å…³è”çš„æ•°æ®åº“

`undo_log`è¡¨å¯¼å…¥åˆ°`å¾®æœåŠ¡`å…³è”çš„æ•°æ®åº“

```sql
SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;

-- ----------------------------
-- Table structure for undo_log
-- ----------------------------
DROP TABLE IF EXISTS `undo_log`;
CREATE TABLE `undo_log`  (
  `branch_id` bigint(20) NOT NULL COMMENT 'branch transaction id',
  `xid` varchar(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL COMMENT 'global transaction id',
  `context` varchar(128) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL COMMENT 'undo_log context,such as serialization',
  `rollback_info` longblob NOT NULL COMMENT 'rollback info',
  `log_status` int(11) NOT NULL COMMENT '0:normal status,1:defense status',
  `log_created` datetime(6) NOT NULL COMMENT 'create datetime',
  `log_modified` datetime(6) NOT NULL COMMENT 'modify datetime',
  UNIQUE INDEX `ux_undo_log`(`xid`, `branch_id`) USING BTREE
) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci COMMENT = 'AT transaction mode undo table' ROW_FORMAT = Compact;


-- ----------------------------
-- Table structure for lock_table
-- ----------------------------
DROP TABLE IF EXISTS `lock_table`;
CREATE TABLE `lock_table`  (
  `row_key` varchar(128) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
  `xid` varchar(96) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `transaction_id` bigint(20) NULL DEFAULT NULL,
  `branch_id` bigint(20) NOT NULL,
  `resource_id` varchar(256) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `table_name` varchar(32) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `pk` varchar(36) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `gmt_create` datetime NULL DEFAULT NULL,
  `gmt_modified` datetime NULL DEFAULT NULL,
  PRIMARY KEY (`row_key`) USING BTREE,
  INDEX `idx_branch_id`(`branch_id`) USING BTREE
) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = Compact;


SET FOREIGN_KEY_CHECKS = 1;
```



ä¿®æ”¹application.ymlæ–‡ä»¶ï¼Œå°†äº‹åŠ¡æ¨¡å¼ä¿®æ”¹ä¸ºATæ¨¡å¼å³å¯ï¼š 

```yaml
 seata: 
   data-source-proxy-mode: AT # å¼€å¯æ•°æ®æºä»£ç†çš„ATæ¨¡å¼
```



é‡å¯æœåŠ¡å¹¶æµ‹è¯•



---



#### 3ï¸âƒ£TCCæ¨¡å¼



TCCæ¨¡å¼ä¸ATæ¨¡å¼éå¸¸ç›¸ä¼¼ï¼Œæ¯é˜¶æ®µéƒ½æ˜¯ç‹¬ç«‹äº‹åŠ¡ï¼Œä¸åŒçš„æ˜¯TCCé€šè¿‡äººå·¥ç¼–ç æ¥å®ç°æ•°æ®æ¢å¤ã€‚

éœ€è¦å®ç°ä¸‰ä¸ªæ–¹æ³• ï¼š

- Tryï¼šèµ„æºçš„æ£€æµ‹å’Œé¢„ç•™
- Confirmï¼šå®Œæˆèµ„æºæ“ä½œä¸šåŠ¡ï¼›è¦æ±‚ Try æˆåŠŸ Confirm ä¸€å®šè¦èƒ½æˆåŠŸã€‚
- Cancelï¼šé¢„ç•™èµ„æºé‡Šæ”¾ï¼Œå¯ä»¥ç†è§£ä¸ºtryçš„åå‘æ“ä½œã€‚







ä¾‹å¦‚ï¼š

---

**é˜¶æ®µä¸€ï¼ˆ Try ï¼‰**ï¼šæ£€æŸ¥ä½™é¢æ˜¯å¦å……è¶³ï¼Œå¦‚æœå……è¶³åˆ™å†»ç»“é‡‘é¢å¢åŠ 30å…ƒï¼Œå¯ç”¨ä½™é¢æ‰£é™¤30

åˆè¯†ä½™é¢ï¼š

![image-20210724182424907](../assets/md-img/åˆ†å¸ƒå¼ç¼“å­˜.assets/image-20210724182424907.png)

ä½™é¢å……è¶³ï¼Œå¯ä»¥å†»ç»“ï¼š

![image-20210724182457951](../assets/md-img/åˆ†å¸ƒå¼ç¼“å­˜.assets/image-20210724182457951.png)



æ­¤æ—¶ï¼Œæ€»é‡‘é¢ = å†»ç»“é‡‘é¢ + å¯ç”¨é‡‘é¢ï¼Œæ•°é‡ä¾ç„¶æ˜¯100ä¸å˜ã€‚äº‹åŠ¡ç›´æ¥æäº¤æ— éœ€ç­‰å¾…å…¶å®ƒäº‹åŠ¡ã€‚

---



**é˜¶æ®µäºŒï¼ˆConfirm)**ï¼šå‡å¦‚è¦æäº¤ï¼ˆConfirmï¼‰ï¼Œåˆ™å†»ç»“é‡‘é¢æ‰£å‡30

ç¡®è®¤å¯ä»¥æäº¤ï¼Œä¸è¿‡ä¹‹å‰å¯ç”¨é‡‘é¢å·²ç»æ‰£å‡è¿‡äº†ï¼Œè¿™é‡Œåªè¦æ¸…é™¤å†»ç»“é‡‘é¢å°±å¥½äº†ï¼š

![image-20210724182706011](../assets/md-img/åˆ†å¸ƒå¼ç¼“å­˜.assets/image-20210724182706011.png)

æ­¤æ—¶ï¼Œæ€»é‡‘é¢ = å†»ç»“é‡‘é¢ + å¯ç”¨é‡‘é¢ = 0 + 70  = 70å…ƒ

---



**é˜¶æ®µäºŒ(Canncel)**ï¼šå¦‚æœè¦å›æ»šï¼ˆCancelï¼‰ï¼Œåˆ™å†»ç»“é‡‘é¢æ‰£å‡30ï¼Œå¯ç”¨ä½™é¢å¢åŠ 30

éœ€è¦å›æ»šï¼Œé‚£ä¹ˆå°±è¦é‡Šæ”¾å†»ç»“é‡‘é¢ï¼Œæ¢å¤å¯ç”¨é‡‘é¢ï¼š

![image-20210724182810734](../assets/md-img/åˆ†å¸ƒå¼ç¼“å­˜.assets/image-20210724182810734.png)

---

---





**TCCçš„å·¥ä½œæ¨¡å‹å›¾ï¼š**

![image-20230311215306253](../assets/md-img/åˆ†å¸ƒå¼ç¼“å­˜.assets/image-20230311215306253.png)

TCCæ¨¡å¼çš„æ¯ä¸ªé˜¶æ®µ

- Tryï¼šèµ„æºæ£€æŸ¥å’Œé¢„ç•™
- Confirmï¼šä¸šåŠ¡æ‰§è¡Œå’Œæäº¤
- Cancelï¼šé¢„ç•™èµ„æºçš„é‡Šæ”¾ 

TCCçš„ä¼˜ç‚¹

- ä¸€é˜¶æ®µå®Œæˆç›´æ¥æäº¤äº‹åŠ¡ï¼Œé‡Šæ”¾æ•°æ®åº“èµ„æºï¼Œæ€§èƒ½å¥½
- ç›¸æ¯”ATæ¨¡å‹ï¼Œæ— éœ€ç”Ÿæˆå¿«ç…§ï¼Œæ— éœ€ä½¿ç”¨å…¨å±€é”ï¼Œæ€§èƒ½æœ€å¼º
- ä¸ä¾èµ–æ•°æ®åº“äº‹åŠ¡ï¼Œè€Œæ˜¯ä¾èµ–è¡¥å¿æ“ä½œï¼Œå¯ä»¥ç”¨äºéäº‹åŠ¡å‹æ•°æ®åº“ 

TCCçš„ç¼ºç‚¹

- æœ‰ä»£ç ä¾µå…¥ï¼Œéœ€è¦äººä¸ºç¼–å†™tryã€Confirmå’ŒCancelæ¥å£ï¼Œå¤ªéº»çƒ¦
- è½¯çŠ¶æ€ï¼Œäº‹åŠ¡æ˜¯æœ€ç»ˆä¸€è‡´
- éœ€è¦è€ƒè™‘Confirmå’ŒCancelçš„å¤±è´¥æƒ…å†µï¼Œåšå¥½å¹‚ç­‰å¤„ç†
- ä¸šä½™å±€é™



---





**åˆ©ç”¨TCCå®ç°åˆ†å¸ƒå¼äº‹åŠ¡**

éœ€æ±‚å¦‚ä¸‹ï¼š 

- ä¿®æ”¹account-serviceï¼Œç¼–å†™tryã€confirmã€cancelé€»è¾‘
- tryä¸šåŠ¡ï¼šæ·»åŠ å†»ç»“é‡‘é¢ï¼Œæ‰£å‡å¯ç”¨é‡‘é¢
- confirmä¸šåŠ¡ï¼šåˆ é™¤å†»ç»“é‡‘é¢
- cancelä¸šåŠ¡ï¼šåˆ é™¤å†»ç»“é‡‘é¢ï¼Œæ¢å¤å¯ç”¨é‡‘é¢
- ä¿è¯confirmã€cancelæ¥å£çš„å¹‚ç­‰æ€§
- å…è®¸ç©ºå›æ»š
- æ‹’ç»ä¸šåŠ¡æ‚¬æŒ‚



TCCçš„ç©ºå›æ»šå’Œä¸šåŠ¡æ‚¬æŒ‚



`ç©ºå›æ»š`ï¼šå½“æŸåˆ†æ”¯äº‹åŠ¡çš„tryé˜¶æ®µé˜»å¡æ—¶ï¼Œå¯èƒ½å¯¼è‡´å…¨å±€äº‹åŠ¡è¶…æ—¶è€Œè§¦å‘äºŒé˜¶æ®µçš„cancelæ“ä½œã€‚åœ¨æœªæ‰§è¡Œtryæ“ä½œæ—¶å…ˆæ‰§è¡Œäº† cancelæ“ä½œï¼Œè¿™æ—¶cancelä¸èƒ½åšå›æ»šï¼Œå°±æ˜¯ç©ºå›æ»šã€‚

`ä¸šåŠ¡æ‚¬æŒ‚`ï¼šå¯¹äºå·²ç»ç©ºå›æ»šçš„ä¸šåŠ¡ï¼Œå¦‚æœä»¥ åç»§ç»­æ‰§è¡Œtryï¼Œå°±æ°¸è¿œä¸å¯èƒ½ confirmæˆ–cancelï¼Œè¿™å°±æ˜¯ä¸šåŠ¡ æ‚¬æŒ‚ã€‚åº”å½“é˜»æ­¢æ‰§è¡Œç©ºå›æ»šåçš„ tryæ“ä½œï¼Œé¿å…æ‚¬æŒ‚

![image-20230311220107126](../assets/md-img/åˆ†å¸ƒå¼ç¼“å­˜.assets/image-20230311220107126.png)

---



![image-20230311220134500](../assets/md-img/åˆ†å¸ƒå¼ç¼“å­˜.assets/image-20230311220134500.png)

```mysql
CREATE TABLE `account_freeze_tbl` (
	`xid` varchar(128) NOT NULL,
	`user_id` varchar(255) DEFAULT NULL COMMENT 'ç”¨æˆ·id',
	`freeze_money` int(11) unsigned DEFAULT '0' COMMENT 'å†»ç»“é‡‘é¢',
	`state` int(1) DEFAULT NULL COMMENT 'äº‹åŠ¡çŠ¶æ€ï¼Œ0:tryï¼Œ1:confirmï¼Œ2:cancel',
    PRIMARY KEY (`xid`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8 ROW_FORMAT=COMPACT;
```





**å£°æ˜TCCæ¥å£**

TCCçš„Tryã€Confirmã€Cancelæ–¹æ³•éƒ½éœ€è¦åœ¨æ¥å£ä¸­åŸºäºæ³¨è§£æ¥å£°æ˜ï¼Œè¯­æ³•å¦‚ä¸‹ï¼š

åœ¨account-serviceé¡¹ç›®ä¸­çš„`com.ganga.account.service`åŒ…ä¸­æ–°å»ºä¸€ä¸ªæ¥å£ï¼Œå£°æ˜TCCä¸‰ä¸ªæ¥å£ï¼š

```java
package com.ganga.account.service;

import io.seata.rm.tcc.api.BusinessActionContext;
import io.seata.rm.tcc.api.BusinessActionContextParameter;
import io.seata.rm.tcc.api.LocalTCC;
import io.seata.rm.tcc.api.TwoPhaseBusinessAction;

@LocalTCC
public interface AccountTCCService {

    @TwoPhaseBusinessAction(name = "deduct", commitMethod = "confirm", rollbackMethod = "cancel")
    void deduct(@BusinessActionContextParameter(paramName = "userId") String userId,
                @BusinessActionContextParameter(paramName = "money")int money);

    boolean confirm(BusinessActionContext ctx);

    boolean cancel(BusinessActionContext ctx);
}
```



ç¼–å†™å®ç°ç±»

åœ¨account-serviceæœåŠ¡ä¸­çš„`com.ganga.account.service.impl`åŒ…ä¸‹æ–°å»ºä¸€ä¸ªç±»ï¼Œå®ç°TCCä¸šåŠ¡ï¼š

```java
@Service
@Slf4j
public class AccountTCCServiceImpl implements AccountTCCService {

    @Autowired
    private AccountMapper accountMapper;
    @Autowired
    private AccountFreezeMapper freezeMapper;

    @Override
    @Transactional
    public void deduct(String userId, int money) {
        // 0.è·å–äº‹åŠ¡id
        String xid = RootContext.getXID();
        // 1.æ‰£å‡å¯ç”¨ä½™é¢
        accountMapper.deduct(userId, money);
        // 2.è®°å½•å†»ç»“é‡‘é¢ï¼Œäº‹åŠ¡çŠ¶æ€
        AccountFreeze freeze = new AccountFreeze();
        freeze.setUserId(userId);
        freeze.setFreezeMoney(money);
        freeze.setState(AccountFreeze.State.TRY);
        freeze.setXid(xid);
        freezeMapper.insert(freeze);
    }

    @Override
    public boolean confirm(BusinessActionContext ctx) {
        // 1.è·å–äº‹åŠ¡id
        String xid = ctx.getXid();
        // 2.æ ¹æ®idåˆ é™¤å†»ç»“è®°å½•
        int count = freezeMapper.deleteById(xid);
        return count == 1;
    }

    @Override
    public boolean cancel(BusinessActionContext ctx) {
        // 0.æŸ¥è¯¢å†»ç»“è®°å½•
        String xid = ctx.getXid();
        AccountFreeze freeze = freezeMapper.selectById(xid);

        // 1.æ¢å¤å¯ç”¨ä½™é¢
        accountMapper.refund(freeze.getUserId(), freeze.getFreezeMoney());
        // 2.å°†å†»ç»“é‡‘é¢æ¸…é›¶ï¼ŒçŠ¶æ€æ”¹ä¸ºCANCEL
        freeze.setFreezeMoney(0);
        freeze.setState(AccountFreeze.State.CANCEL);
        int count = freezeMapper.updateById(freeze);
        return count == 1;
    }
}
```





---





#### 4ï¸âƒ£SAGAæ¨¡å¼

Saga æ¨¡å¼æ˜¯ Seata å³å°†å¼€æºçš„é•¿äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œå°†ç”±èš‚èšé‡‘æœä¸»è¦è´¡çŒ®ã€‚

å…¶ç†è®ºåŸºç¡€æ˜¯ `Hector` & `Kenneth`åœ¨1987å¹´å‘è¡¨çš„è®ºæ–‡[Sagas](https://microservices.io/patterns/data/saga.html)ã€‚

Seataå®˜ç½‘å¯¹äºSagaçš„æŒ‡å—ï¼šhttps://seata.io/zh-cn/docs/user/saga.html





**åŸç†**

åœ¨`Sagaæ¨¡å¼`ä¸‹ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡å†…æœ‰å¤šä¸ªå‚ä¸è€…ï¼Œæ¯ä¸€ä¸ªå‚ä¸è€…éƒ½æ˜¯ä¸€ä¸ªå†²æ­£è¡¥å¿æœåŠ¡ï¼Œéœ€è¦ç”¨æˆ·æ ¹æ®ä¸šåŠ¡åœºæ™¯å®ç°å…¶æ­£å‘æ“ä½œå’Œé€†å‘å›æ»šæ“ä½œã€‚

åˆ†å¸ƒå¼äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¾æ¬¡æ‰§è¡Œå„å‚ä¸è€…çš„æ­£å‘æ“ä½œï¼Œå¦‚æœæ‰€æœ‰æ­£å‘æ“ä½œå‡æ‰§è¡ŒæˆåŠŸï¼Œé‚£ä¹ˆåˆ†å¸ƒå¼äº‹åŠ¡æäº¤ã€‚å¦‚æœä»»ä½•ä¸€ä¸ªæ­£å‘æ“ä½œæ‰§è¡Œå¤±è´¥ï¼Œé‚£ä¹ˆåˆ†å¸ƒå¼äº‹åŠ¡ä¼šå»é€€å›å»æ‰§è¡Œå‰é¢å„å‚ä¸è€…çš„é€†å‘å›æ»šæ“ä½œï¼Œå›æ»šå·²æäº¤çš„å‚ä¸è€…ï¼Œä½¿åˆ†å¸ƒå¼äº‹åŠ¡å›åˆ°åˆå§‹çŠ¶æ€ã€‚

![image-20230311221005583](../assets/md-img/åˆ†å¸ƒå¼ç¼“å­˜.assets/image-20230311221005583.png)

Sagaæ¨¡å¼æ˜¯SEATAæä¾›çš„é•¿äº‹åŠ¡è§£å†³æ–¹æ¡ˆã€‚ä¹Ÿåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š

- ä¸€é˜¶æ®µï¼šç›´æ¥æäº¤æœ¬åœ°äº‹åŠ¡
- äºŒé˜¶æ®µï¼šæˆåŠŸåˆ™ä»€ä¹ˆéƒ½ä¸åšï¼›å¤±è´¥åˆ™é€šè¿‡ç¼–å†™è¡¥å¿ä¸šåŠ¡æ¥å›æ»š



Sagaæ¨¡å¼ä¼˜ç‚¹ï¼š

- äº‹åŠ¡å‚ä¸è€…å¯ä»¥åŸºäºäº‹ä»¶é©±åŠ¨å®ç°å¼‚æ­¥è°ƒç”¨ï¼Œååé«˜
- ä¸€é˜¶æ®µç›´æ¥æäº¤äº‹åŠ¡ï¼Œæ— é”ï¼Œæ€§èƒ½å¥½
- ä¸ç”¨ç¼–å†™TCCä¸­çš„ä¸‰ä¸ªé˜¶æ®µï¼Œå®ç°ç®€å• 

Sagaæ¨¡å¼ç¼ºç‚¹ï¼š

- è½¯çŠ¶æ€æŒç»­æ—¶é—´ä¸ç¡®å®šï¼Œæ—¶æ•ˆæ€§å·®
- æ²¡æœ‰é”ï¼Œæ²¡æœ‰äº‹åŠ¡éš”ç¦»ï¼Œä¼šæœ‰è„å†™





#### ğŸ†šå››ç§æ¨¡å¼å¯¹æ¯”

![image-20230311221914300](../assets/md-img/åˆ†å¸ƒå¼ç¼“å­˜.assets/image-20230311221914300.png)





#### ğŸ†˜Seataé«˜å¯ç”¨



 

**TCçš„å¼‚åœ°å¤šæœºæˆ¿å®¹ç¾æ¶æ„**

TCæœåŠ¡ä½œä¸ºSeataçš„æ ¸å¿ƒæœåŠ¡ï¼Œä¸€å®šè¦ä¿è¯é«˜å¯ç”¨å’Œå¼‚åœ°å®¹ç¾ã€‚

![image-20230311222733286](../assets/md-img/åˆ†å¸ƒå¼ç¼“å­˜.assets/image-20230311222733286.png)



---



**1ï¸âƒ£æ¨¡æ‹Ÿå¼‚åœ°å®¹ç¾çš„TCé›†ç¾¤**



è®¡åˆ’å¯åŠ¨ä¸¤å°seataçš„tcæœåŠ¡èŠ‚ç‚¹ï¼š

| èŠ‚ç‚¹åç§° | ipåœ°å€    | ç«¯å£å· | é›†ç¾¤åç§° |
| -------- | --------- | ------ | -------- |
| seata    | 127.0.0.1 | 8091   | SH       |
| seata2   | 127.0.0.1 | 8092   | HZ       |

ä¹‹å‰æˆ‘ä»¬å·²ç»å¯åŠ¨äº†ä¸€å°seataæœåŠ¡ï¼Œç«¯å£æ˜¯8091ï¼Œé›†ç¾¤åä¸ºSHã€‚

ç°åœ¨ï¼Œå°†seataç›®å½•å¤åˆ¶ä¸€ä»½ï¼Œèµ·åä¸ºseata2

ä¿®æ”¹`seata2/conf/registry.conf`æˆ–`seata2/conf/application.yaml`å†…å®¹å¦‚ä¸‹ï¼š

```yaml
registry {
  # tcæœåŠ¡çš„æ³¨å†Œä¸­å¿ƒç±»ï¼Œè¿™é‡Œé€‰æ‹©nacosï¼Œä¹Ÿå¯ä»¥æ˜¯eurekaã€zookeeperç­‰
  type = "nacos"

  nacos {
    # seata tc æœåŠ¡æ³¨å†Œåˆ° nacosçš„æœåŠ¡åç§°ï¼Œå¯ä»¥è‡ªå®šä¹‰
    application = "seata-tc-server"
    serverAddr = "127.0.0.1:8848"
    group = "DEFAULT_GROUP"
    namespace = ""
    cluster = "HZ"
    username = "nacos"
    password = "nacos"
  }
}

config {
  # è¯»å–tcæœåŠ¡ç«¯çš„é…ç½®æ–‡ä»¶çš„æ–¹å¼ï¼Œè¿™é‡Œæ˜¯ä»nacosé…ç½®ä¸­å¿ƒè¯»å–ï¼Œè¿™æ ·å¦‚æœtcæ˜¯é›†ç¾¤ï¼Œå¯ä»¥å…±äº«é…ç½®
  type = "nacos"
  # é…ç½®nacosåœ°å€ç­‰ä¿¡æ¯
  nacos {
    serverAddr = "127.0.0.1:8848"
    namespace = ""
    group = "SEATA_GROUP"
    username = "nacos"
    password = "nacos"
    dataId = "seataServer.properties"
  }
}
```



è¿›å…¥seata2/binç›®å½•ï¼Œç„¶åè¿è¡Œå‘½ä»¤ï¼š

```powershell
seata-server.bat -p 8092
```

æ‰“å¼€nacosæ§åˆ¶å°ï¼ŒæŸ¥çœ‹æœåŠ¡åˆ—è¡¨ï¼š

![image-20210624151150840](../assets/md-img/åˆ†å¸ƒå¼ç¼“å­˜.assets/image-20210624151150840.png)

ç‚¹è¿›è¯¦æƒ…æŸ¥çœ‹ï¼š

![image-20210624151221747](../assets/md-img/åˆ†å¸ƒå¼ç¼“å­˜.assets/image-20210624151221747.png)





**2ï¸âƒ£å°†äº‹åŠ¡ç»„æ˜ å°„é…ç½®åˆ°nacos**

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦å°†tx-service-groupä¸clusterçš„æ˜ å°„å…³ç³»éƒ½é…ç½®åˆ°nacosé…ç½®ä¸­å¿ƒã€‚

æ–°å»ºä¸€ä¸ªé…ç½®ï¼š

![image-20210624151507072](../assets/md-img/åˆ†å¸ƒå¼ç¼“å­˜.assets/image-20210624151507072.png)

é…ç½®çš„å†…å®¹å¦‚ä¸‹ï¼š

```properties
# äº‹åŠ¡ç»„æ˜ å°„å…³ç³»
service.vgroupMapping.seata-demo=SH

service.enableDegrade=false
service.disableGlobalTransaction=false
# ä¸TCæœåŠ¡çš„é€šä¿¡é…ç½®
transport.type=TCP
transport.server=NIO
transport.heartbeat=true
transport.enableClientBatchSendRequest=false
transport.threadFactory.bossThreadPrefix=NettyBoss
transport.threadFactory.workerThreadPrefix=NettyServerNIOWorker
transport.threadFactory.serverExecutorThreadPrefix=NettyServerBizHandler
transport.threadFactory.shareBossWorker=false
transport.threadFactory.clientSelectorThreadPrefix=NettyClientSelector
transport.threadFactory.clientSelectorThreadSize=1
transport.threadFactory.clientWorkerThreadPrefix=NettyClientWorkerThread
transport.threadFactory.bossThreadSize=1
transport.threadFactory.workerThreadSize=default
transport.shutdown.wait=3
# RMé…ç½®
client.rm.asyncCommitBufferLimit=10000
client.rm.lock.retryInterval=10
client.rm.lock.retryTimes=30
client.rm.lock.retryPolicyBranchRollbackOnConflict=true
client.rm.reportRetryCount=5
client.rm.tableMetaCheckEnable=false
client.rm.tableMetaCheckerInterval=60000
client.rm.sqlParserType=druid
client.rm.reportSuccessEnable=false
client.rm.sagaBranchRegisterEnable=false
# TMé…ç½®
client.tm.commitRetryCount=5
client.tm.rollbackRetryCount=5
client.tm.defaultGlobalTransactionTimeout=60000
client.tm.degradeCheck=false
client.tm.degradeCheckAllowTimes=10
client.tm.degradeCheckPeriod=2000

# undoæ—¥å¿—é…ç½®
client.undo.dataValidation=true
client.undo.logSerialization=jackson
client.undo.onlyCareUpdateColumns=true
client.undo.logTable=undo_log
client.undo.compress.enable=true
client.undo.compress.type=zip
client.undo.compress.threshold=64k
client.log.exceptionRate=100
```







**3ï¸âƒ£å¾®æœåŠ¡è¯»å–nacosé…ç½®**

æ¥ä¸‹æ¥ï¼Œéœ€è¦ä¿®æ”¹æ¯ä¸€ä¸ªå¾®æœåŠ¡çš„application.ymlæ–‡ä»¶ï¼Œè®©å¾®æœåŠ¡è¯»å–nacosä¸­çš„client.propertiesæ–‡ä»¶ï¼š

```yaml
seata:
  config:
    type: nacos
    nacos:
      server-addr: 127.0.0.1:8848
      username: nacos
      password: nacos
      group: SEATA_GROUP
      data-id: client.properties
```







**3ï¸âƒ£é‡å¯å¾®æœåŠ¡**ï¼Œç°åœ¨å¾®æœåŠ¡åˆ°åº•æ˜¯è¿æ¥tcçš„SHé›†ç¾¤ï¼Œè¿˜æ˜¯tcçš„HZé›†ç¾¤ï¼Œéƒ½ç»Ÿä¸€ç”±nacosçš„client.propertiesæ¥å†³å®šäº†ã€‚











