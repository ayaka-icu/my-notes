



## æœåŠ¡å¼‚æ­¥é€šä¿¡çš„é«˜çº§ç¯‡







MQç”¨èµ·æ¥å¾ˆç®€å•ï¼Œæ•ˆæœä¹Ÿå¾ˆå¥½ï¼Œä½†æ˜¯ï¼Œåœ¨ä½¿ç”¨ä¸­æœ‰å¾ˆå¤šå‘ï¼Œè¯´ä¸å®šå“ªå¤©åˆ«äººç»™ä½ å†™çš„ğŸ’Œå°±åœ¨é˜´å·®é˜³é”™ä¸­ä¸¢å¤±äº†....

ä¸ºæ­¤ï¼Œè¦å¯¹MQè¿›è¡Œæ·±å…¥çš„äº†è§£ï¼ŒğŸ†—ï¼Œä¸ºäº†ä¿è¯ğŸ’Œçš„å®‰å…¨......å­¦ä¹ å¥½MQé«˜çº§æ˜¯å¾ˆæœ‰å¿…è¦çš„ï¼





æ¶ˆæ¯é˜Ÿåˆ—åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œé¢ä¸´ç€å¾ˆå¤šå®é™…é—®é¢˜éœ€è¦æ€è€ƒï¼š

![image-20210718155003157](../assets/md-img/RabbitMQ.assets/image-20210718155003157.png)







## æ¶ˆæ¯å¯é æ€§

å…ˆçœ‹ä¸€ä¸‹ï¼Œäº¤æ¢æœºæ¨¡å¼ä¸‹ï¼ŒğŸ’Œæ˜¯å¦‚ä½•åˆ°ä½ æ‰‹ä¸Šçš„...

æ¶ˆæ¯ä»å‘é€ï¼Œåˆ°æ¶ˆè´¹è€…æ¥æ”¶ï¼Œä¼šç»ç†å¤šä¸ªè¿‡ç¨‹ï¼š

![image-20210718155059371](../assets/md-img/RabbitMQ.assets/image-20210718155059371.png)



å…¶ä¸­çš„æ¯ä¸€æ­¥éƒ½å¯èƒ½å¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ï¼Œå¸¸è§çš„ä¸¢å¤±åŸå› åŒ…æ‹¬ï¼š

- **å‘é€æ—¶ä¸¢å¤±**ï¼š
  - **ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯æœªé€è¾¾exchange**
  - **æ¶ˆæ¯åˆ°è¾¾exchangeåæœªåˆ°è¾¾queue**
- **MQå®•æœºï¼Œqueueå°†æ¶ˆæ¯ä¸¢å¤±**
- **consumeræ¥æ”¶åˆ°æ¶ˆæ¯åæœªæ¶ˆè´¹å°±å®•æœº**



é’ˆå¯¹è¿™äº›é—®é¢˜ï¼ŒRabbitMQåˆ†åˆ«ç»™å‡ºäº†è§£å†³æ–¹æ¡ˆï¼š

```mermaid
  graph LR
  
  ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶ --> è§£å†³
  è§£å†³ --> å‘é€æ—¶ä¸¢å¤±é—®é¢˜
```

```mermaid
  graph LR
  
  
  MQæŒä¹…åŒ– --> è§£å†³
  è§£å†³ --> MQå®•æœºå¯¼è‡´queueå°†æ¶ˆæ¯ä¸¢å¤±
```

```mermaid
    graph LR
    
    
    æ¶ˆè´¹è€…ç¡®è®¤æœºåˆ¶ --> è§£å†³
    è§£å†³ --> consumeræ¥æ”¶åˆ°æ¶ˆæ¯åæœªæ¶ˆè´¹å°±å®•æœº
```

```mermaid
  graph LR
      
      
  å¤±è´¥é‡è¯•æœºåˆ¶ --> è§£å†³
  è§£å†³ --> consumeræˆåŠŸæ¶ˆè´¹æ¶ˆæ¯
```

 è¿™é‡Œå·å·ç”¨äº†ä¸‹ mermaid...







### ç”Ÿäº§è€…æ¶ˆæ¯ç¡®è®¤



RabbitMQæä¾›äº†publisher confirmæœºåˆ¶æ¥é¿å…æ¶ˆæ¯å‘é€åˆ°MQè¿‡ç¨‹ä¸­ä¸¢å¤±ã€‚

è¿™ç§æœºåˆ¶å¿…é¡»ç»™æ¯ä¸ªæ¶ˆæ¯æŒ‡å®šä¸€ä¸ªå”¯ä¸€IDã€‚æ¶ˆæ¯å‘é€åˆ°MQä»¥åï¼Œä¼šè¿”å›ä¸€ä¸ªç»“æœç»™å‘é€è€…ï¼Œè¡¨ç¤ºæ¶ˆæ¯æ˜¯å¦å¤„ç†æˆåŠŸã€‚

è¿”å›ç»“æœæœ‰ä¸¤ç§æ–¹å¼ï¼š

- publisher-confirmï¼Œå‘é€è€…ç¡®è®¤
  - æ¶ˆæ¯æˆåŠŸæŠ•é€’åˆ°äº¤æ¢æœºï¼Œè¿”å›`ack`
  - æ¶ˆæ¯æœªæŠ•é€’åˆ°äº¤æ¢æœºï¼Œè¿”å›`nack`
- publisher-returnï¼Œå‘é€è€…å›æ‰§
  - æ¶ˆæ¯æŠ•é€’åˆ°äº¤æ¢æœºäº†ï¼Œä½†æ˜¯æ²¡æœ‰è·¯ç”±åˆ°é˜Ÿåˆ—ã€‚è¿”å›`ACK`åŠ`åŠè·¯ç”±å¤±è´¥åŸå› `ã€‚

![image-20210718160907166](../assets/md-img/RabbitMQ.assets/image-20210718160907166.png)



æ³¨æ„ï¼š

![image-20210718161707992](../assets/md-img/RabbitMQ.assets/image-20210718161707992.png)



#### ä¿®æ”¹é…ç½®

é¦–å…ˆï¼Œä¿®æ”¹publisheræœåŠ¡ä¸­çš„application.ymlæ–‡ä»¶ï¼Œæ·»åŠ ä¸‹é¢çš„å†…å®¹ï¼š

```yaml
spring:
  rabbitmq:
    publisher-confirm-type: correlated # simple ä¸æ¨é€‰
    publisher-returns: true
    template:
      mandatory: true # è°ƒç”¨ReturnCallback æ¨é€‰
```

è¯´æ˜ï¼š

- `publish-confirm-type`ï¼šå¼€å¯publisher-confirmï¼Œè¿™é‡Œæ”¯æŒä¸¤ç§ç±»å‹ï¼š
  - `simple`ï¼šåŒæ­¥ç­‰å¾…confirmç»“æœï¼Œç›´åˆ°è¶…æ—¶
  - `correlated`ï¼šå¼‚æ­¥å›è°ƒï¼Œå®šä¹‰ConfirmCallbackï¼ŒMQè¿”å›ç»“æœæ—¶ä¼šå›è°ƒè¿™ä¸ªConfirmCallback
- `publish-returns`ï¼šå¼€å¯publish-returnåŠŸèƒ½ï¼ŒåŒæ ·æ˜¯åŸºäºcallbackæœºåˆ¶ï¼Œä¸è¿‡æ˜¯å®šä¹‰ReturnCallback
- `template.mandatory`ï¼šå®šä¹‰æ¶ˆæ¯è·¯ç”±å¤±è´¥æ—¶çš„ç­–ç•¥ã€‚trueï¼Œåˆ™è°ƒç”¨ReturnCallbackï¼›falseï¼šåˆ™ç›´æ¥ä¸¢å¼ƒæ¶ˆæ¯



<hr>



#### äº¤æ¢æœºâ¡ï¸æ¶ˆæ¯é˜Ÿåˆ—

æ¶ˆæ¯æˆåŠŸå‘é€ç»™äº†äº¤æ¢æœºï¼Œäº¤æ¢æœºä¼šå°†æ¶ˆæ¯è·¯ç”±åˆ°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè¿™ä¸€è¿‡ç¨‹å¯èƒ½ä¼šå¤±è´¥ï¼Œå¯ä»¥é€šè¿‡é…ç½®RabbitTemplateçš„`setRabbitTemplate()`/`setRabbitsTemplate()`æ–¹æ³•è¿›è¡Œè®¾ç½®è¿”å›å›æ‰§ã€‚ å‰è€…è¿‡æ—¶ï¼Œåè€…æ–°ã€‚

æ¯ä¸ªRabbitTemplateåªèƒ½é…ç½®ä¸€ä¸ªRabbitTemplateï¼Œå› æ­¤éœ€è¦åœ¨é¡¹ç›®åŠ è½½æ—¶é…ç½®ï¼š



ä¿®æ”¹`publisher`æœåŠ¡ï¼Œæ·»åŠ ä¸€ä¸ªé…ç½®ï¼š

```java
@Slf4j
@Configuration
public class RabbitConfig implements ApplicationContextAware {
    @Override
    public void setApplicationContext(ApplicationContext applicationContext) throws BeansException {
        // è·å–RabbitTemplate
        RabbitTemplate rabbitTemplate = applicationContext.getBean(RabbitTemplate.class);
        // è®¾ç½®ReturnCallback
        rabbitTemplate.setReturnCallback((message, replyCode, replyText, exchange, routingKey) -> {
            // æŠ•é€’å¤±è´¥ï¼Œè®°å½•æ—¥å¿—
            log.info("æ¶ˆæ¯å‘é€å¤±è´¥ï¼Œåº”ç­”ç {}ï¼ŒåŸå› {}ï¼Œäº¤æ¢æœº{}ï¼Œè·¯ç”±é”®{},æ¶ˆæ¯{}",
                     replyCode, replyText, exchange, routingKey, message.toString());
            // å¦‚æœæœ‰ä¸šåŠ¡éœ€è¦ï¼Œå¯ä»¥é‡å‘æ¶ˆæ¯
        });
    }
}
```

ä¸Šé¢çš„æ–¹æ³•çš„`setReturnCallback`æ–¹æ³• å’Œ `ReturnCallback`æ¥å£å·²ç»è¿‡æ—¶äº†

è¿™é‡Œæˆ‘æ˜¯è¿™æ ·å†™çš„ï¼š

```java
@Slf4j
@Configuration
public class RabbitConfig {

    @Autowired
    private RabbitTemplate rabbitTemplate;

    @PostConstruct
    public void init(){
        //è®¾ç½®å›è°ƒå‡½æ•°
        rabbitTemplate.setReturnsCallback(rm -> {
            //è®°å½•æ—¥å¿—
            log.info(
                    "æ¶ˆæ¯å‘é€å¤±è´¥, äº¤æ¢æœº->é˜Ÿåˆ—, -->-->......\n" + 
                    "-->å¤±è´¥ä¿¡æ¯\n-->åº”ç­”ç :{},\n-->åŸå› :{},\n-->äº¤æ¢æœº:{},\n-->è·¯ç”±é”®:{},\n-->æ¶ˆæ¯:{}",
                    rm.getReplyCode(),
                    rm.getReplyText(),
                    rm.getExchange(),
                    rm.getRoutingKey(),
                    rm.getMessage());
        });
    }
}
```







#### å‘é€è€…â¡ï¸äº¤æ¢æœº

åœ¨æ¶ˆæ¯å‘é€æ—¶å®šä¹‰ConfirmCallback

ConfirmCallbackå¯ä»¥åœ¨å‘é€æ¶ˆæ¯æ—¶æŒ‡å®šï¼Œå› ä¸ºæ¯ä¸ªä¸šåŠ¡å¤„ç†confirmæˆåŠŸæˆ–å¤±è´¥çš„é€»è¾‘ä¸ä¸€å®šç›¸åŒã€‚

åœ¨publisheræœåŠ¡ï¼Œæ¶ˆæ¯å‘é€æ—¶æ·»åŠ ï¼š

```java
public static final String ROUTING_KEY = "mes.qs";
public static final String EXCHANGE = "qs.topic";
public static final String ERR_ROUTING_KEY = "mes.xxx";	//é”™è¯¯çš„routingKey
public static final String ERR_EXCHANGE = "xxx.topic";	//é”™è¯¯çš„äº¤æ¢æœº

@Test
public void testSendMessageQs2() throws InterruptedException {
    String message = "I Love You ...ğŸ’Œ";
    //è®¾ç½®ConfirmCallback
    //1.è®¾ç½®ä¸€ä¸ªå…¨å±€å”¯ä¸€æ¶ˆæ¯id,éœ€è¦å°è£…åˆ°CorrelationDataä¸­
    CorrelationData correlationData = new CorrelationData(UUID.randomUUID().toString());
    //2.æ·»åŠ Callback
    correlationData.getFuture().addCallback(
            result -> {
                if (result.isAck()){
                    log.debug("ç”Ÿäº§è€…->äº¤æ¢æœº,æ¶ˆæ¯å‘é€æˆåŠŸ, ID:{}", correlationData.getId());
                }else {
                    log.error("ç”Ÿäº§è€…->äº¤æ¢æœº,æ¶ˆæ¯å‘é€å¤±è´¥, ID:{}",correlationData.getId());
                }
            },
            ex -> log.error("æ¶ˆæ¯å‘é€å¼‚å¸¸, ID:{}, åŸå› :{}",correlationData.getId(),ex.getMessage())
    );
    //3.å‘é€æ¶ˆæ¯,å°†correlationDataæ”¾å…¥
    //æ¨¡æ‹Ÿå‘é€æ­£å¸¸
    //rabbitTemplate.convertAndSend(EXCHANGE, ROUTING_KEY, message, correlationData);
    //æ¨¡æ‹Ÿå‘é€å¤±è´¥    ç”Ÿäº§è€… --> äº¤æ¢æœº
    //rabbitTemplate.convertAndSend(ERR_EXCHANGE, ROUTING_KEY, message, correlationData);
    //æ¨¡æ‹Ÿå‘é€å¤±è´¥    äº¤æ¢æœº --> é˜Ÿåˆ—
    rabbitTemplate.convertAndSend(EXCHANGE, ERR_ROUTING_KEY, message, correlationData);
    
    //Testä¸‹,æ²¡æœ‰ç­‰åˆ°ackå›æ‰§å°±è¿è¡Œç»“æŸäº†,è¿™é‡Œæ¨¡æ‹Ÿç­‰å¾…ä¸€ä¼šå„¿ï¼Œç­‰å¾…ackå›æ‰§
    Thread.sleep(2000);
}
```



#### æµ‹è¯•ç»“æœ

æ¥æ¨¡æ‹Ÿæµ‹è¯•ä¸€ä¸‹ `ç”Ÿäº§è€… --> äº¤æ¢æœº` çš„å¤±è´¥

```java
//æ¨¡æ‹Ÿé”™è¯¯çš„äº¤æ¢æœºå‘é€å¤±è´¥    ç”Ÿäº§è€… --> äº¤æ¢æœº
rabbitTemplate.convertAndSend(ERR_EXCHANGE, ROUTING_KEY, message, correlationData);
```

![image-20230403221000067](../assets/md-img/RabbitMQ.assets/image-20230403221000067.png)

æ‰§è¡Œäº†

<hr>

æ¨¡æ‹Ÿæµ‹è¯•ä¸€ä¸‹ `äº¤æ¢æœº --> é˜Ÿåˆ—` çš„å¤±è´¥

```java
//æ¨¡æ‹Ÿé”™è¯¯çš„æ¶ˆæ¯é˜Ÿåˆ—å‘é€å¤±è´¥    ç”Ÿäº§è€… --> äº¤æ¢æœº
rabbitTemplate.convertAndSend(ERR_EXCHANGE, ROUTING_KEY, message, correlationData);
```

![image-20230403221441466](../assets/md-img/RabbitMQ.assets/image-20230403221441466.png)

è¿™é‡Œå¯ä»¥çœ‹å‡º `ç”Ÿäº§è€… --> äº¤æ¢æœº` æ˜¯æˆåŠŸçš„ï¼Œä½†æ˜¯ï¼Œ`äº¤æ¢æœº --> é˜Ÿåˆ—` æ˜¯å¤±è´¥çš„ã€‚





<hr>



### æ¶ˆæ¯æŒä¹…åŒ–

ç”Ÿäº§è€…ç¡®è®¤å¯ä»¥ç¡®ä¿æ¶ˆæ¯æŠ•é€’åˆ°RabbitMQçš„é˜Ÿåˆ—ä¸­ï¼Œä½†æ˜¯æ¶ˆæ¯å‘é€åˆ°RabbitMQä»¥åï¼Œå¦‚æœçªç„¶å®•æœºï¼Œä¹Ÿå¯èƒ½å¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ã€‚

è¦æƒ³ç¡®ä¿æ¶ˆæ¯åœ¨RabbitMQä¸­å®‰å…¨ä¿å­˜ï¼Œå¿…é¡»å¼€å¯æ¶ˆæ¯æŒä¹…åŒ–æœºåˆ¶ã€‚

- äº¤æ¢æœºæŒä¹…åŒ–
- é˜Ÿåˆ—æŒä¹…åŒ–
- æ¶ˆæ¯æŒä¹…åŒ–



çœè¯»ï¼SpringAMQPä¸­å¯ä»¥é€šè¿‡`ä»£ç `æŒ‡å®š`äº¤æ¢æœº`ã€`æ¶ˆæ¯é˜Ÿåˆ—`éƒ½æ˜¯`é»˜è®¤æŒä¹…åŒ–çš„`ã€‚



<hr>



#### äº¤æ¢æœºæŒä¹…åŒ–

RabbitMQä¸­äº¤æ¢æœºé»˜è®¤æ˜¯éæŒä¹…åŒ–çš„ï¼Œmqé‡å¯åå°±ä¸¢å¤±ã€‚

SpringAMQPä¸­å¯ä»¥é€šè¿‡ä»£ç æŒ‡å®šäº¤æ¢æœºæŒä¹…åŒ–ï¼š

```java
@Bean
public DirectExchange simpleExchange(){
    // ä¸‰ä¸ªå‚æ•°ï¼šäº¤æ¢æœºåç§°ã€æ˜¯å¦æŒä¹…åŒ–ã€å½“æ²¡æœ‰queueä¸å…¶ç»‘å®šæ—¶æ˜¯å¦è‡ªåŠ¨åˆ é™¤
    return new DirectExchange("simple.direct", true, false);
}
```

äº‹å®ä¸Šï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œç”±SpringAMQPå£°æ˜çš„äº¤æ¢æœºéƒ½æ˜¯æŒä¹…åŒ–çš„ã€‚



å¯ä»¥åœ¨RabbitMQæ§åˆ¶å°çœ‹åˆ°æŒä¹…åŒ–çš„äº¤æ¢æœºéƒ½ä¼šå¸¦ä¸Š`D`çš„æ ‡ç¤ºï¼š

![image-20230403223338693](../assets/md-img/RabbitMQ.assets/image-20230403223338693.png)





#### é˜Ÿåˆ—æŒä¹…åŒ–

RabbitMQä¸­é˜Ÿåˆ—é»˜è®¤æ˜¯éæŒä¹…åŒ–çš„ï¼Œmqé‡å¯åå°±ä¸¢å¤±ã€‚

SpringAMQPä¸­å¯ä»¥é€šè¿‡ä»£ç æŒ‡å®šäº¤æ¢æœºæŒä¹…åŒ–ï¼š

```java
@Bean
public Queue simpleQueue(){
    // ä½¿ç”¨QueueBuilderæ„å»ºé˜Ÿåˆ—ï¼Œdurableå°±æ˜¯æŒä¹…åŒ–çš„
    return QueueBuilder.durable("simple.queue").build();
}
```

äº‹å®ä¸Šï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œç”±SpringAMQPå£°æ˜çš„é˜Ÿåˆ—éƒ½æ˜¯æŒä¹…åŒ–çš„ã€‚

å¯ä»¥åœ¨RabbitMQæ§åˆ¶å°çœ‹åˆ°æŒä¹…åŒ–çš„é˜Ÿåˆ—éƒ½ä¼šå¸¦ä¸Š`D`çš„æ ‡ç¤ºï¼š

![image-20210718164729543](../assets/md-img/RabbitMQ.assets/image-20210718164729543.png)



#### æ¶ˆæ¯æŒä¹…åŒ–

åˆ©ç”¨SpringAMQPå‘é€æ¶ˆæ¯æ—¶ï¼Œå¯ä»¥è®¾ç½®æ¶ˆæ¯çš„å±æ€§ï¼ˆMessagePropertiesï¼‰ï¼ŒæŒ‡å®šdelivery-modeï¼š

- 1ï¼šéæŒä¹…åŒ–
- 2ï¼šæŒä¹…åŒ–

ç”¨javaä»£ç æŒ‡å®šï¼š

![image-20210718165100016](../assets/md-img/RabbitMQ.assets/image-20210718165100016.png)



é»˜è®¤æƒ…å†µä¸‹ï¼ŒSpringAMQPå‘å‡ºçš„ä»»ä½•æ¶ˆæ¯éƒ½æ˜¯æŒä¹…åŒ–çš„ï¼Œä¸ç”¨ç‰¹æ„æŒ‡å®šã€‚



<hr>



### æ¶ˆè´¹è€…æ¶ˆæ¯ç¡®è®¤

RabbitMQæ˜¯**é˜…åå³ç„š**æœºåˆ¶ï¼ŒRabbitMQç¡®è®¤æ¶ˆæ¯è¢«æ¶ˆè´¹è€…æ¶ˆè´¹åä¼šç«‹åˆ»åˆ é™¤ã€‚

è€ŒRabbitMQæ˜¯é€šè¿‡æ¶ˆè´¹è€…å›æ‰§æ¥ç¡®è®¤æ¶ˆè´¹è€…æ˜¯å¦æˆåŠŸå¤„ç†æ¶ˆæ¯çš„ï¼šæ¶ˆè´¹è€…è·å–æ¶ˆæ¯åï¼Œåº”è¯¥å‘RabbitMQå‘é€ACKå›æ‰§ï¼Œè¡¨æ˜è‡ªå·±å·²ç»å¤„ç†æ¶ˆæ¯ã€‚



è®¾æƒ³è¿™æ ·çš„åœºæ™¯ï¼š

1. RabbitMQæŠ•é€’æ¶ˆæ¯ç»™æ¶ˆè´¹è€…
2. æ¶ˆè´¹è€…è·å–æ¶ˆæ¯åï¼Œè¿”å›ACKç»™RabbitMQ
3. RabbitMQåˆ é™¤æ¶ˆæ¯
4. æ¶ˆè´¹è€…å®•æœºï¼Œæ¶ˆæ¯å°šæœªå¤„ç†

è¿™æ ·ï¼Œæ¶ˆæ¯å°±ä¸¢å¤±äº†ã€‚å› æ­¤æ¶ˆè´¹è€…è¿”å›ACKçš„æ—¶æœºéå¸¸é‡è¦ã€‚



è€ŒSpringAMQPåˆ™å…è®¸é…ç½®ä¸‰ç§ç¡®è®¤æ¨¡å¼ï¼š

- manualï¼šæ‰‹åŠ¨ackï¼Œéœ€è¦åœ¨ä¸šåŠ¡ä»£ç ç»“æŸåï¼Œè°ƒç”¨apiå‘é€ackã€‚
- autoï¼šè‡ªåŠ¨ackï¼Œç”±springç›‘æµ‹listenerä»£ç æ˜¯å¦å‡ºç°å¼‚å¸¸ï¼Œæ²¡æœ‰å¼‚å¸¸åˆ™è¿”å›ackï¼›æŠ›å‡ºå¼‚å¸¸åˆ™è¿”å›nack
- noneï¼šå…³é—­ackï¼ŒMQå‡å®šæ¶ˆè´¹è€…è·å–æ¶ˆæ¯åä¼šæˆåŠŸå¤„ç†ï¼Œå› æ­¤æ¶ˆæ¯æŠ•é€’åç«‹å³è¢«åˆ é™¤



ç”±æ­¤å¯çŸ¥ï¼š

- noneæ¨¡å¼ä¸‹ï¼Œæ¶ˆæ¯æŠ•é€’æ˜¯ä¸å¯é çš„ï¼Œå¯èƒ½ä¸¢å¤±
- autoæ¨¡å¼ç±»ä¼¼äº‹åŠ¡æœºåˆ¶ï¼Œå‡ºç°å¼‚å¸¸æ—¶è¿”å›nackï¼Œæ¶ˆæ¯å›æ»šåˆ°mqï¼›æ²¡æœ‰å¼‚å¸¸ï¼Œè¿”å›ack
- manualï¼šè‡ªå·±æ ¹æ®ä¸šåŠ¡æƒ…å†µï¼Œåˆ¤æ–­ä»€ä¹ˆæ—¶å€™è¯¥ack

ä¸€èˆ¬ï¼Œæˆ‘ä»¬éƒ½æ˜¯ä½¿ç”¨é»˜è®¤çš„autoå³å¯ã€‚



#### æ¼”ç¤ºnoneæ¨¡å¼

ä¿®æ”¹consumeræœåŠ¡çš„application.ymlæ–‡ä»¶ï¼Œæ·»åŠ ä¸‹é¢å†…å®¹ï¼š

```yaml
spring:
  rabbitmq:
    listener:
      simple:
        acknowledge-mode: none # å…³é—­ack
```

ä¿®æ”¹consumeræœåŠ¡çš„SpringRabbitListenerç±»ä¸­çš„æ–¹æ³•ï¼Œæ¨¡æ‹Ÿä¸€ä¸ªæ¶ˆæ¯å¤„ç†å¼‚å¸¸ï¼š

```java
@RabbitListener(queues = "qs.queue")
public void listenSimpleQueue2(String msg) {
    System.out.println("ä½ æ¥å—åˆ°äº†ä¸€å°ğŸ’Œ...");
    System.out.println("ä½ å°†è¦æ‰“å¼€ğŸ’Œ...");
    System.out.println("å°±åœ¨æ­¤æ—¶æ­¤åˆ»...ä½ åŸºå‹å‡ºç°...");
    System.out.println("ä»–æŠ¢èµ°ğŸ’Œ...å¹¶å°†å…¶é”€æ¯...");
    System.out.print("æ¶ˆæ¯å†…å®¹æ˜¯: ");
    System.out.print(1/0);
    System.out.print(msg);
}
```

ç›‘å¬ç»“æœï¼š

![image-20230403231428739](../assets/md-img/RabbitMQ.assets/image-20230403231428739.png)

æµ‹è¯•å¯ä»¥å‘ç°ï¼Œå½“æ¶ˆæ¯å¤„ç†æŠ›å¼‚å¸¸æ—¶ï¼Œæ¶ˆæ¯ä¾ç„¶è¢«RabbitMQåˆ é™¤äº†ã€‚



<hr>



#### æ¼”ç¤ºautoæ¨¡å¼

å†æ¬¡æŠŠç¡®è®¤æœºåˆ¶ä¿®æ”¹ä¸ºauto:

```yaml
spring:
  rabbitmq:
    listener:
      simple:
        acknowledge-mode: auto # å…³é—­ack
```

åœ¨å¼‚å¸¸ä½ç½®æ‰“æ–­ç‚¹ï¼Œå†æ¬¡å‘é€æ¶ˆæ¯ï¼Œç¨‹åºå¡åœ¨æ–­ç‚¹æ—¶ï¼Œå¯ä»¥å‘ç°æ­¤æ—¶æ¶ˆæ¯çŠ¶æ€ä¸ºunackï¼ˆæœªç¡®å®šçŠ¶æ€ï¼‰ï¼š

![image-20210718171705383](../assets/md-img/RabbitMQ.assets/image-20210718171705383.png)

æŠ›å‡ºå¼‚å¸¸åï¼Œå› ä¸ºSpringä¼šè‡ªåŠ¨è¿”å›nackï¼Œæ‰€ä»¥æ¶ˆæ¯æ¢å¤è‡³ReadyçŠ¶æ€ï¼Œå¹¶ä¸”æ²¡æœ‰è¢«RabbitMQåˆ é™¤ï¼š

![image-20210718171759179](../assets/md-img/RabbitMQ.assets/image-20210718171759179.png)

è¿˜æœ‰å°±æ˜¯,Springä¼šä¸€ç›´`é‡è¯•`â¡ï¸`å¤±è´¥`â¡ï¸`é‡è¯•`â¡ï¸`å¤±è´¥`â¡ï¸ ......



<hr>



### æ¶ˆè´¹å¤±è´¥é‡è¯•æœºåˆ¶

å½“æ¶ˆè´¹è€…å‡ºç°å¼‚å¸¸åï¼Œæ¶ˆæ¯ä¼šä¸æ–­requeueï¼ˆé‡å…¥é˜Ÿï¼‰åˆ°é˜Ÿåˆ—ï¼Œå†é‡æ–°å‘é€ç»™æ¶ˆè´¹è€…ï¼Œç„¶åå†æ¬¡å¼‚å¸¸ï¼Œå†æ¬¡requeueï¼Œæ— é™å¾ªç¯ï¼Œå¯¼è‡´mqçš„æ¶ˆæ¯å¤„ç†é£™å‡ï¼Œå¸¦æ¥ä¸å¿…è¦çš„å‹åŠ›ï¼š

![image-20210718172746378](../assets/md-img/RabbitMQ.assets/image-20210718172746378.png)

æ€ä¹ˆåŠå‘¢ï¼Ÿ





#### æœ¬åœ°é‡è¯•

æˆ‘ä»¬å¯ä»¥åˆ©ç”¨Springçš„retryæœºåˆ¶ï¼Œåœ¨æ¶ˆè´¹è€…å‡ºç°å¼‚å¸¸æ—¶åˆ©ç”¨æœ¬åœ°é‡è¯•ï¼Œè€Œä¸æ˜¯æ— é™åˆ¶çš„requeueåˆ°mqé˜Ÿåˆ—ã€‚

ä¿®æ”¹consumeræœåŠ¡çš„application.ymlæ–‡ä»¶ï¼Œæ·»åŠ å†…å®¹ï¼š

```yaml
spring:
  rabbitmq:
    listener:
      simple:
        retry:
          enabled: true # å¼€å¯æ¶ˆè´¹è€…å¤±è´¥é‡è¯•
          initial-interval: 1000 # åˆè¯†çš„å¤±è´¥ç­‰å¾…æ—¶é•¿ä¸º1ç§’
          multiplier: 1 # å¤±è´¥çš„ç­‰å¾…æ—¶é•¿å€æ•°ï¼Œä¸‹æ¬¡ç­‰å¾…æ—¶é•¿ = multiplier * last-interval
          max-attempts: 3 # æœ€å¤§é‡è¯•æ¬¡æ•°
          stateless: true # trueæ— çŠ¶æ€ï¼›falseæœ‰çŠ¶æ€ã€‚å¦‚æœä¸šåŠ¡ä¸­åŒ…å«äº‹åŠ¡ï¼Œè¿™é‡Œæ”¹ä¸ºfalse
```



é‡å¯consumeræœåŠ¡ï¼Œé‡å¤ä¹‹å‰çš„æµ‹è¯•ã€‚å¯ä»¥å‘ç°ï¼š

- åœ¨é‡è¯•3æ¬¡åï¼ŒSpringAMQPä¼šæŠ›å‡ºå¼‚å¸¸AmqpRejectAndDontRequeueExceptionï¼Œè¯´æ˜æœ¬åœ°é‡è¯•è§¦å‘äº†
- æŸ¥çœ‹RabbitMQæ§åˆ¶å°ï¼Œå‘ç°æ¶ˆæ¯è¢«åˆ é™¤äº†ï¼Œè¯´æ˜æœ€åSpringAMQPè¿”å›çš„æ˜¯ackï¼Œmqåˆ é™¤æ¶ˆæ¯äº†



ç»“è®ºï¼š

- å¼€å¯æœ¬åœ°é‡è¯•æ—¶ï¼Œæ¶ˆæ¯å¤„ç†è¿‡ç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸ï¼Œä¸ä¼šrequeueåˆ°é˜Ÿåˆ—ï¼Œè€Œæ˜¯åœ¨æ¶ˆè´¹è€…æœ¬åœ°é‡è¯•
- é‡è¯•è¾¾åˆ°æœ€å¤§æ¬¡æ•°åï¼ŒSpringä¼šè¿”å›ackï¼Œæ¶ˆæ¯ä¼šè¢«ä¸¢å¼ƒ



<hr>

#### å¤±è´¥ç­–ç•¥

åœ¨ä¹‹å‰çš„æµ‹è¯•ä¸­ï¼Œè¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°åï¼Œæ¶ˆæ¯ä¼šè¢«ä¸¢å¼ƒï¼Œè¿™æ˜¯ç”±Springå†…éƒ¨æœºåˆ¶å†³å®šçš„ã€‚

åœ¨å¼€å¯é‡è¯•æ¨¡å¼åï¼Œé‡è¯•æ¬¡æ•°è€—å°½ï¼Œå¦‚æœæ¶ˆæ¯ä¾ç„¶å¤±è´¥ï¼Œåˆ™éœ€è¦æœ‰MessageRecoveryæ¥å£æ¥å¤„ç†ï¼Œå®ƒåŒ…å«ä¸‰ç§ä¸åŒçš„å®ç°ï¼š

- RejectAndDontRequeueRecovererï¼šé‡è¯•è€—å°½åï¼Œç›´æ¥rejectï¼Œä¸¢å¼ƒæ¶ˆæ¯ã€‚é»˜è®¤å°±æ˜¯è¿™ç§æ–¹å¼

- ImmediateRequeueMessageRecovererï¼šé‡è¯•è€—å°½åï¼Œè¿”å›nackï¼Œæ¶ˆæ¯é‡æ–°å…¥é˜Ÿ

- RepublishMessageRecovererï¼šé‡è¯•è€—å°½åï¼Œå°†å¤±è´¥æ¶ˆæ¯æŠ•é€’åˆ°æŒ‡å®šçš„äº¤æ¢æœº



**æ¯”è¾ƒä¼˜é›…çš„**ä¸€ç§å¤„ç†æ–¹æ¡ˆæ˜¯RepublishMessageRecovererï¼Œå¤±è´¥åå°†æ¶ˆæ¯æŠ•é€’åˆ°ä¸€ä¸ªæŒ‡å®šçš„ï¼Œä¸“é—¨å­˜æ”¾å¼‚å¸¸æ¶ˆæ¯çš„é˜Ÿåˆ—ï¼Œåç»­ç”±äººå·¥é›†ä¸­å¤„ç†ã€‚



1. åœ¨consumeræœåŠ¡ä¸­å®šä¹‰å¤„ç†å¤±è´¥æ¶ˆæ¯çš„äº¤æ¢æœºå’Œé˜Ÿåˆ—
2. å®šä¹‰ä¸€ä¸ªRepublishMessageRecovererï¼Œå…³è”é˜Ÿåˆ—å’Œäº¤æ¢æœº

å®Œæ•´ä»£ç ï¼š

```java
@Configuration
public class ErrorMQ {

    @Bean
    public DirectExchange errorMessageExchange(){
        return new DirectExchange("error.direct");
    }
    @Bean
    public Queue errorQueue(){
        return new Queue("error.queue", true);
    }
    @Bean
    public Binding errorBinding(Queue errorQueue, DirectExchange errorMessageExchange){
        return BindingBuilder.bind(errorQueue).to(errorMessageExchange).with("error");
    }

    @Bean
    public MessageRecoverer republishMessageRecoverer(RabbitTemplate rabbitTemplate){
        return new RepublishMessageRecoverer(rabbitTemplate, "error.direct", "error");
    }
}
```





<hr>



### æ€»ç»“ğŸŒ¸ğŸŒ¸

å¦‚ä½•ç¡®ä¿RabbitMQæ¶ˆæ¯çš„å¯é æ€§ï¼Ÿ

- å¼€å¯ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶ï¼Œç¡®ä¿ç”Ÿäº§è€…çš„æ¶ˆæ¯èƒ½åˆ°è¾¾é˜Ÿåˆ—
- å¼€å¯æŒä¹…åŒ–åŠŸèƒ½ï¼Œç¡®ä¿æ¶ˆæ¯æœªæ¶ˆè´¹å‰åœ¨é˜Ÿåˆ—ä¸­ä¸ä¼šä¸¢å¤±
- å¼€å¯æ¶ˆè´¹è€…ç¡®è®¤æœºåˆ¶ä¸ºautoï¼Œç”±springç¡®è®¤æ¶ˆæ¯å¤„ç†æˆåŠŸåå®Œæˆack
- å¼€å¯æ¶ˆè´¹è€…å¤±è´¥é‡è¯•æœºåˆ¶ï¼Œå¹¶è®¾ç½®MessageRecovererï¼Œå¤šæ¬¡é‡è¯•å¤±è´¥åå°†æ¶ˆæ¯æŠ•é€’åˆ°å¼‚å¸¸äº¤æ¢æœºï¼Œäº¤ç”±äººå·¥å¤„ç†





<hr>







## æ­»ä¿¡äº¤æ¢æœº





### ä»€ä¹ˆæ˜¯æ­»ä¿¡äº¤æ¢æœº

ä»€ä¹ˆæ˜¯æ­»ä¿¡ï¼Ÿ

å½“ä¸€ä¸ªé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯æ»¡è¶³ä¸‹åˆ—æƒ…å†µä¹‹ä¸€æ—¶ï¼Œå¯ä»¥æˆä¸ºæ­»ä¿¡ï¼ˆdead letterï¼‰ï¼š

- æ¶ˆè´¹è€…ä½¿ç”¨`basic.reject`æˆ–`basic.nack`å£°æ˜æ¶ˆè´¹å¤±è´¥ï¼Œå¹¶ä¸”æ¶ˆæ¯çš„requeueå‚æ•°è®¾ç½®ä¸ºfalse
- æ¶ˆæ¯æ˜¯ä¸€ä¸ªè¿‡æœŸæ¶ˆæ¯ï¼Œè¶…æ—¶æ— äººæ¶ˆè´¹
- è¦æŠ•é€’çš„é˜Ÿåˆ—æ¶ˆæ¯æ»¡äº†ï¼Œæ— æ³•æŠ•é€’



å¦‚æœè¿™ä¸ªåŒ…å«æ­»ä¿¡çš„é˜Ÿåˆ—é…ç½®äº†`dead-letter-exchange`å±æ€§ï¼ŒæŒ‡å®šäº†ä¸€ä¸ªäº¤æ¢æœºï¼Œé‚£ä¹ˆé˜Ÿåˆ—ä¸­çš„æ­»ä¿¡å°±ä¼šæŠ•é€’åˆ°è¿™ä¸ªäº¤æ¢æœºä¸­ï¼Œè€Œè¿™ä¸ªäº¤æ¢æœºç§°ä¸º**æ­»ä¿¡äº¤æ¢æœº**ï¼ˆDead Letter Exchangeï¼Œæ£€æŸ¥DLXï¼‰ã€‚



å¦‚å›¾ï¼Œä¸€ä¸ªæ¶ˆæ¯è¢«æ¶ˆè´¹è€…æ‹’ç»äº†ï¼Œå˜æˆäº†æ­»ä¿¡ï¼š

![image-20210718174328383](../assets/md-img/RabbitMQ.assets/image-20210718174328383.png)

å› ä¸ºsimple.queueç»‘å®šäº†æ­»ä¿¡äº¤æ¢æœº dl.directï¼Œå› æ­¤æ­»ä¿¡ä¼šæŠ•é€’ç»™è¿™ä¸ªäº¤æ¢æœºï¼š

![image-20210718174416160](../assets/md-img/RabbitMQ.assets/image-20210718174416160.png)

å¦‚æœè¿™ä¸ªæ­»ä¿¡äº¤æ¢æœºä¹Ÿç»‘å®šäº†ä¸€ä¸ªé˜Ÿåˆ—ï¼Œåˆ™æ¶ˆæ¯æœ€ç»ˆä¼šè¿›å…¥è¿™ä¸ªå­˜æ”¾æ­»ä¿¡çš„é˜Ÿåˆ—ï¼š

![image-20210718174506856](../assets/md-img/RabbitMQ.assets/image-20210718174506856.png)



å¦å¤–ï¼Œé˜Ÿåˆ—å°†æ­»ä¿¡æŠ•é€’ç»™æ­»ä¿¡äº¤æ¢æœºæ—¶ï¼Œå¿…é¡»çŸ¥é“ä¸¤ä¸ªä¿¡æ¯ï¼š

- æ­»ä¿¡äº¤æ¢æœºåç§°
- æ­»ä¿¡äº¤æ¢æœºä¸æ­»ä¿¡é˜Ÿåˆ—ç»‘å®šçš„RoutingKey

è¿™æ ·æ‰èƒ½ç¡®ä¿æŠ•é€’çš„æ¶ˆæ¯èƒ½åˆ°è¾¾æ­»ä¿¡äº¤æ¢æœºï¼Œå¹¶ä¸”æ­£ç¡®çš„è·¯ç”±åˆ°æ­»ä¿¡é˜Ÿåˆ—ã€‚

![image-20210821073801398](../assets/md-img/RabbitMQ.assets/image-20210821073801398.png)



<hr>

### æ­»ä¿¡äº¤æ¢æœºæ¥æ”¶æ­»ä¿¡

**åˆ©ç”¨æ­»ä¿¡äº¤æ¢æœºæ¥æ”¶æ­»ä¿¡ï¼ˆæ‹“å±•ï¼‰**

åœ¨å¤±è´¥é‡è¯•ç­–ç•¥ä¸­ï¼Œé»˜è®¤çš„RejectAndDontRequeueRecovererä¼šåœ¨æœ¬åœ°é‡è¯•æ¬¡æ•°è€—å°½åï¼Œå‘é€rejectç»™RabbitMQï¼Œæ¶ˆæ¯å˜æˆæ­»ä¿¡ï¼Œè¢«ä¸¢å¼ƒã€‚



æˆ‘ä»¬å¯ä»¥ç»™simple.queueæ·»åŠ ä¸€ä¸ªæ­»ä¿¡äº¤æ¢æœºï¼Œç»™æ­»ä¿¡äº¤æ¢æœºç»‘å®šä¸€ä¸ªé˜Ÿåˆ—ã€‚è¿™æ ·æ¶ˆæ¯å˜æˆæ­»ä¿¡åä¹Ÿä¸ä¼šä¸¢å¼ƒï¼Œè€Œæ˜¯æœ€ç»ˆæŠ•é€’åˆ°æ­»ä¿¡äº¤æ¢æœºï¼Œè·¯ç”±åˆ°ä¸æ­»ä¿¡äº¤æ¢æœºç»‘å®šçš„é˜Ÿåˆ—ã€‚



![image-20210718174506856](../assets/md-img/RabbitMQ.assets/image-20210718174506856.png)



æˆ‘ä»¬åœ¨consumeræœåŠ¡ä¸­ï¼Œå®šä¹‰ä¸€ç»„æ­»ä¿¡äº¤æ¢æœºã€æ­»ä¿¡é˜Ÿåˆ—ï¼š

```java
@Configuration
public class DeadLetterTest {

    @Bean
    public TopicExchange qsTopicExchange(){
        return new TopicExchange("qs.topic");
    }
    
    // å£°æ˜æ™®é€šçš„queueé˜Ÿåˆ—ï¼Œå¹¶ä¸”ä¸ºå…¶æŒ‡å®šæ­»ä¿¡äº¤æ¢æœºï¼šdl.direct
    @Bean
    public Queue qsQueue(){
        return QueueBuilder.durable("qs.queue") // æŒ‡å®šé˜Ÿåˆ—åç§°ï¼Œå¹¶æŒä¹…åŒ–
                .deadLetterExchange("dl.direct") // æŒ‡å®šæ­»ä¿¡äº¤æ¢æœº
                .build();
    }

    @Bean
    public Binding binding(){
        return BindingBuilder.bind(qsQueue()).to(qsTopicExchange()).with("mes.qs");
    }

    // ======================================================================================
    
    // å£°æ˜æ­»ä¿¡äº¤æ¢æœº dl.direct
    @Bean
    public DirectExchange dlExchange(){
        return new DirectExchange("dl.direct", true, false);
    }
    // å£°æ˜å­˜å‚¨æ­»ä¿¡çš„é˜Ÿåˆ— dl.queue
    @Bean
    public Queue dlQueue(){
        return new Queue("dl.queue", true);
    }
    // å°†æ­»ä¿¡é˜Ÿåˆ— ä¸ æ­»ä¿¡äº¤æ¢æœºç»‘å®š
    @Bean
    public Binding dlBinding(){
        return BindingBuilder.bind(dlQueue()).to(dlExchange()).with("simple");
    }

}

```





**æ€»ç»“**

ä»€ä¹ˆæ ·çš„æ¶ˆæ¯ä¼šæˆä¸ºæ­»ä¿¡ï¼Ÿ

- æ¶ˆæ¯è¢«æ¶ˆè´¹è€…rejectæˆ–è€…è¿”å›nack
- æ¶ˆæ¯è¶…æ—¶æœªæ¶ˆè´¹
- é˜Ÿåˆ—æ»¡äº†

æ­»ä¿¡äº¤æ¢æœºçš„ä½¿ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿ

- å¦‚æœé˜Ÿåˆ—ç»‘å®šäº†æ­»ä¿¡äº¤æ¢æœºï¼Œæ­»ä¿¡ä¼šæŠ•é€’åˆ°æ­»ä¿¡äº¤æ¢æœºï¼›
- å¯ä»¥åˆ©ç”¨æ­»ä¿¡äº¤æ¢æœºæ”¶é›†æ‰€æœ‰æ¶ˆè´¹è€…å¤„ç†å¤±è´¥çš„æ¶ˆæ¯ï¼ˆæ­»ä¿¡ï¼‰ï¼Œäº¤ç”±äººå·¥å¤„ç†ï¼Œè¿›ä¸€æ­¥æé«˜æ¶ˆæ¯é˜Ÿåˆ—çš„å¯é æ€§ã€‚



<hr>





### TTL

ä¸€ä¸ªé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯å¦‚æœè¶…æ—¶æœªæ¶ˆè´¹ï¼Œåˆ™ä¼šå˜ä¸ºæ­»ä¿¡ï¼Œè¶…æ—¶åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š

- æ¶ˆæ¯æ‰€åœ¨çš„é˜Ÿåˆ—è®¾ç½®äº†è¶…æ—¶æ—¶é—´
- æ¶ˆæ¯æœ¬èº«è®¾ç½®äº†è¶…æ—¶æ—¶é—´

![image-20210718182643311](../assets/md-img/RabbitMQ.assets/image-20210718182643311.png)



### æ¥æ”¶è¶…æ—¶æ­»ä¿¡çš„æ­»ä¿¡äº¤æ¢æœº

åœ¨consumeræœåŠ¡çš„SpringRabbitListenerä¸­ï¼Œå®šä¹‰ä¸€ä¸ªæ–°çš„æ¶ˆè´¹è€…ï¼Œå¹¶ä¸”å£°æ˜ æ­»ä¿¡äº¤æ¢æœºã€æ­»ä¿¡é˜Ÿåˆ—ï¼š

```java
@RabbitListener(bindings = @QueueBinding(
    value = @Queue(name = "dl.ttl.queue", durable = "true"),
    exchange = @Exchange(name = "dl.ttl.direct"),
    key = "ttl"
))
public void listenDlQueue(String msg){
    log.info("æ¥æ”¶åˆ° dl.ttl.queueçš„å»¶è¿Ÿæ¶ˆæ¯ï¼š{}", msg);
}
```



### å£°æ˜ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå¹¶ä¸”æŒ‡å®šTTL

è¦ç»™é˜Ÿåˆ—è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œéœ€è¦åœ¨å£°æ˜é˜Ÿåˆ—æ—¶é…ç½®x-message-ttlå±æ€§ï¼š

```java
@Bean
public Queue ttlQueue(){
    return QueueBuilder.durable("ttl.queue") // æŒ‡å®šé˜Ÿåˆ—åç§°ï¼Œå¹¶æŒä¹…åŒ–
        .ttl(10000) // è®¾ç½®é˜Ÿåˆ—çš„è¶…æ—¶æ—¶é—´ï¼Œ10ç§’
        .deadLetterExchange("dl.ttl.direct") // æŒ‡å®šæ­»ä¿¡äº¤æ¢æœº
        .build();
}
```

æ³¨æ„ï¼Œè¿™ä¸ªé˜Ÿåˆ—è®¾å®šäº†æ­»ä¿¡äº¤æ¢æœºä¸º`dl.ttl.direct`



å£°æ˜äº¤æ¢æœºï¼Œå°†ttlä¸äº¤æ¢æœºç»‘å®šï¼š

```java
@Bean
public DirectExchange ttlExchange(){
    return new DirectExchange("ttl.direct");
}
@Bean
public Binding ttlBinding(){
    return BindingBuilder.bind(ttlQueue()).to(ttlExchange()).with("ttl");
}
```



å‘é€æ¶ˆæ¯ï¼Œä½†æ˜¯ä¸è¦æŒ‡å®šTTLï¼š

```java
@Test
public void testTTLQueue() {
    // åˆ›å»ºæ¶ˆæ¯
    String message = "hello, ttl queue";
    // æ¶ˆæ¯IDï¼Œéœ€è¦å°è£…åˆ°CorrelationDataä¸­
    CorrelationData correlationData = new CorrelationData(UUID.randomUUID().toString());
    // å‘é€æ¶ˆæ¯
    rabbitTemplate.convertAndSend("ttl.direct", "ttl", message, correlationData);
    // è®°å½•æ—¥å¿—
    log.debug("å‘é€æ¶ˆæ¯æˆåŠŸ");
}
```

å‘é€æ¶ˆæ¯çš„æ—¥å¿—ï¼š

![image-20210718191657478](../assets/md-img/RabbitMQ.assets/image-20210718191657478.png)



æŸ¥çœ‹ä¸‹æ¥æ”¶æ¶ˆæ¯çš„æ—¥å¿—ï¼š

![image-20210718191738706](../assets/md-img/RabbitMQ.assets/image-20210718191738706.png)



å› ä¸ºé˜Ÿåˆ—çš„TTLå€¼æ˜¯10000msï¼Œä¹Ÿå°±æ˜¯10ç§’ã€‚å¯ä»¥çœ‹åˆ°æ¶ˆæ¯å‘é€ä¸æ¥æ”¶ä¹‹é—´çš„æ—¶å·®åˆšå¥½æ˜¯10ç§’ã€‚



### å‘é€æ¶ˆæ¯æ—¶ï¼Œè®¾å®šTTL

åœ¨å‘é€æ¶ˆæ¯æ—¶ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šTTLï¼š

```java
@Test
public void testTTLMsg() {
    // åˆ›å»ºæ¶ˆæ¯
    Message message = MessageBuilder
        .withBody("hello, ttl message".getBytes(StandardCharsets.UTF_8))
        .setExpiration("5000")
        .build();
    // æ¶ˆæ¯IDï¼Œéœ€è¦å°è£…åˆ°CorrelationDataä¸­
    CorrelationData correlationData = new CorrelationData(UUID.randomUUID().toString());
    // å‘é€æ¶ˆæ¯
    rabbitTemplate.convertAndSend("ttl.direct", "ttl", message, correlationData);
    log.debug("å‘é€æ¶ˆæ¯æˆåŠŸ");
}
```



æŸ¥çœ‹å‘é€æ¶ˆæ¯æ—¥å¿—ï¼š

![image-20210718191939140](../assets/md-img/RabbitMQ.assets/image-20210718191939140.png)

æ¥æ”¶æ¶ˆæ¯æ—¥å¿—ï¼š

![image-20210718192004662](../assets/md-img/RabbitMQ.assets/image-20210718192004662.png)



è¿™æ¬¡ï¼Œå‘é€ä¸æ¥æ”¶çš„å»¶è¿Ÿåªæœ‰5ç§’ã€‚è¯´æ˜å½“é˜Ÿåˆ—ã€æ¶ˆæ¯éƒ½è®¾ç½®äº†TTLæ—¶ï¼Œä»»æ„ä¸€ä¸ªåˆ°æœŸå°±ä¼šæˆä¸ºæ­»ä¿¡ã€‚



**æ€»ç»“**

æ¶ˆæ¯è¶…æ—¶çš„ä¸¤ç§æ–¹å¼æ˜¯ï¼Ÿ

- ç»™é˜Ÿåˆ—è®¾ç½®ttlå±æ€§ï¼Œè¿›å…¥é˜Ÿåˆ—åè¶…è¿‡ttlæ—¶é—´çš„æ¶ˆæ¯å˜ä¸ºæ­»ä¿¡
- ç»™æ¶ˆæ¯è®¾ç½®ttlå±æ€§ï¼Œé˜Ÿåˆ—æ¥æ”¶åˆ°æ¶ˆæ¯è¶…è¿‡ttlæ—¶é—´åå˜ä¸ºæ­»ä¿¡

å¦‚ä½•å®ç°å‘é€ä¸€ä¸ªæ¶ˆæ¯20ç§’åæ¶ˆè´¹è€…æ‰æ”¶åˆ°æ¶ˆæ¯ï¼Ÿ

- ç»™æ¶ˆæ¯çš„ç›®æ ‡é˜Ÿåˆ—æŒ‡å®šæ­»ä¿¡äº¤æ¢æœº
- å°†æ¶ˆè´¹è€…ç›‘å¬çš„é˜Ÿåˆ—ç»‘å®šåˆ°æ­»ä¿¡äº¤æ¢æœº
- å‘é€æ¶ˆæ¯æ—¶ç»™æ¶ˆæ¯è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º20ç§’





<hr>



## å»¶è¿Ÿé˜Ÿåˆ—

åˆ©ç”¨TTLç»“åˆæ­»ä¿¡äº¤æ¢æœºï¼Œæˆ‘ä»¬å®ç°äº†æ¶ˆæ¯å‘å‡ºåï¼Œæ¶ˆè´¹è€…å»¶è¿Ÿæ”¶åˆ°æ¶ˆæ¯çš„æ•ˆæœã€‚è¿™ç§æ¶ˆæ¯æ¨¡å¼å°±ç§°ä¸ºå»¶è¿Ÿé˜Ÿåˆ—ï¼ˆDelay Queueï¼‰æ¨¡å¼ã€‚

å»¶è¿Ÿé˜Ÿåˆ—çš„ä½¿ç”¨åœºæ™¯åŒ…æ‹¬ï¼š

- å»¶è¿Ÿå‘é€çŸ­ä¿¡
- ç”¨æˆ·ä¸‹å•ï¼Œå¦‚æœç”¨æˆ·åœ¨15 åˆ†é’Ÿå†…æœªæ”¯ä»˜ï¼Œåˆ™è‡ªåŠ¨å–æ¶ˆ
- é¢„çº¦å·¥ä½œä¼šè®®ï¼Œ20åˆ†é’Ÿåè‡ªåŠ¨é€šçŸ¥æ‰€æœ‰å‚ä¼šäººå‘˜



å› ä¸ºå»¶è¿Ÿé˜Ÿåˆ—çš„éœ€æ±‚éå¸¸å¤šï¼Œæ‰€ä»¥RabbitMQçš„å®˜æ–¹ä¹Ÿæ¨å‡ºäº†ä¸€ä¸ªæ’ä»¶ï¼ŒåŸç”Ÿæ”¯æŒå»¶è¿Ÿé˜Ÿåˆ—æ•ˆæœã€‚

è¿™ä¸ªæ’ä»¶å°±æ˜¯DelayExchangeæ’ä»¶ã€‚å‚è€ƒRabbitMQçš„æ’ä»¶åˆ—è¡¨é¡µé¢ï¼šhttps://www.rabbitmq.com/community-plugins.html

![image-20210718192529342](../assets/md-img/RabbitMQ.assets/image-20210718192529342.png)



ä½¿ç”¨æ–¹å¼å¯ä»¥å‚è€ƒå®˜ç½‘åœ°å€ï¼šhttps://blog.rabbitmq.com/posts/2015/04/scheduling-messages-with-rabbitmq





### å®‰è£…DelayExchangeæ’ä»¶



å®˜æ–¹çš„å®‰è£…æŒ‡å—åœ°å€ä¸ºï¼šhttps://blog.rabbitmq.com/posts/2015/04/scheduling-messages-with-rabbitmq

ä¸Šè¿°æ–‡æ¡£æ˜¯åŸºäºlinuxåŸç”Ÿå®‰è£…RabbitMQï¼Œç„¶åå®‰è£…æ’ä»¶ã€‚



å› ä¸ºæˆ‘ä»¬ä¹‹å‰æ˜¯åŸºäºDockerå®‰è£…RabbitMQï¼Œæ‰€ä»¥ä¸‹é¢æˆ‘ä»¬ä¼šè®²è§£åŸºäºDockeræ¥å®‰è£…RabbitMQæ’ä»¶ã€‚

#### ä¸‹è½½æ’ä»¶

RabbitMQæœ‰ä¸€ä¸ªå®˜æ–¹çš„æ’ä»¶ç¤¾åŒºï¼Œåœ°å€ä¸ºï¼šhttps://www.rabbitmq.com/community-plugins.html

å…¶ä¸­åŒ…å«å„ç§å„æ ·çš„æ’ä»¶ï¼ŒåŒ…æ‹¬æˆ‘ä»¬è¦ä½¿ç”¨çš„DelayExchangeæ’ä»¶ï¼š

![image-20210713104511055](../assets/md-img/RabbitMQ.assets/image-20210713104511055.png)



å¤§å®¶å¯ä»¥å»å¯¹åº”çš„GitHubé¡µé¢ä¸‹è½½3.8.9ç‰ˆæœ¬çš„æ’ä»¶ï¼Œåœ°å€ä¸ºhttps://github.com/rabbitmq/rabbitmq-delayed-message-exchange/releases/tag/3.8.9è¿™ä¸ªå¯¹åº”RabbitMQçš„3.8.5ä»¥ä¸Šç‰ˆæœ¬ã€‚



è¯¾å‰èµ„æ–™ä¹Ÿæä¾›äº†ä¸‹è½½å¥½çš„æ’ä»¶ï¼š

![image-20210713104808909](../assets/md-img/RabbitMQ.assets/image-20210713104808909.png)



#### ä¸Šä¼ æ’ä»¶

å› ä¸ºæˆ‘ä»¬æ˜¯åŸºäºDockerå®‰è£…ï¼Œæ‰€ä»¥éœ€è¦å…ˆæŸ¥çœ‹RabbitMQçš„æ’ä»¶ç›®å½•å¯¹åº”çš„æ•°æ®å·ã€‚å¦‚æœä¸æ˜¯åŸºäºDockerçš„åŒå­¦ï¼Œè¯·å‚è€ƒç¬¬ä¸€ç« éƒ¨åˆ†ï¼Œé‡æ–°åˆ›å»ºDockerå®¹å™¨ã€‚

æˆ‘ä»¬ä¹‹å‰è®¾å®šçš„RabbitMQçš„æ•°æ®å·åç§°ä¸º`mq-plugins`ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨ä¸‹é¢å‘½ä»¤æŸ¥çœ‹æ•°æ®å·ï¼š

```sh
docker volume inspect mq-plugins
```

å¯ä»¥å¾—åˆ°ä¸‹é¢ç»“æœï¼š

![image-20210713105135701](../assets/md-img/RabbitMQ.assets/image-20210713105135701.png)

æ¥ä¸‹æ¥ï¼Œå°†æ’ä»¶ä¸Šä¼ åˆ°è¿™ä¸ªç›®å½•å³å¯ï¼š

![image-20210713105339785](../assets/md-img/RabbitMQ.assets/image-20210713105339785.png)



#### å®‰è£…æ’ä»¶

æœ€åå°±æ˜¯å®‰è£…äº†ï¼Œéœ€è¦è¿›å…¥MQå®¹å™¨å†…éƒ¨æ¥æ‰§è¡Œå®‰è£…ã€‚æˆ‘çš„å®¹å™¨åä¸º`mq`ï¼Œæ‰€ä»¥æ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼š

```sh
docker exec -it mq bash
```

æ‰§è¡Œæ—¶ï¼Œè¯·å°†å…¶ä¸­çš„ `-it` åé¢çš„`mq`æ›¿æ¢ä¸ºä½ è‡ªå·±çš„å®¹å™¨å.

è¿›å…¥å®¹å™¨å†…éƒ¨åï¼Œæ‰§è¡Œä¸‹é¢å‘½ä»¤å¼€å¯æ’ä»¶ï¼š

```sh
rabbitmq-plugins enable rabbitmq_delayed_message_exchange
```

ç»“æœå¦‚ä¸‹ï¼š

![image-20210713105829435](../assets/md-img/RabbitMQ.assets/image-20210713105829435.png)









### DelayExchangeåŸç†

DelayExchangeéœ€è¦å°†ä¸€ä¸ªäº¤æ¢æœºå£°æ˜ä¸ºdelayedç±»å‹ã€‚å½“æˆ‘ä»¬å‘é€æ¶ˆæ¯åˆ°delayExchangeæ—¶ï¼Œæµç¨‹å¦‚ä¸‹ï¼š

- æ¥æ”¶æ¶ˆæ¯
- åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦å…·å¤‡x-delayå±æ€§
- å¦‚æœæœ‰x-delayå±æ€§ï¼Œè¯´æ˜æ˜¯å»¶è¿Ÿæ¶ˆæ¯ï¼ŒæŒä¹…åŒ–åˆ°ç¡¬ç›˜ï¼Œè¯»å–x-delayå€¼ï¼Œä½œä¸ºå»¶è¿Ÿæ—¶é—´
- è¿”å›routing not foundç»“æœç»™æ¶ˆæ¯å‘é€è€…
- x-delayæ—¶é—´åˆ°æœŸåï¼Œé‡æ–°æŠ•é€’æ¶ˆæ¯åˆ°æŒ‡å®šé˜Ÿåˆ—



### ä½¿ç”¨DelayExchange

æ’ä»¶çš„ä½¿ç”¨ä¹Ÿéå¸¸ç®€å•ï¼šå£°æ˜ä¸€ä¸ªäº¤æ¢æœºï¼Œäº¤æ¢æœºçš„ç±»å‹å¯ä»¥æ˜¯ä»»æ„ç±»å‹ï¼Œåªéœ€è¦è®¾å®šdelayedå±æ€§ä¸ºtrueå³å¯ï¼Œç„¶åå£°æ˜é˜Ÿåˆ—ä¸å…¶ç»‘å®šå³å¯ã€‚

#### å£°æ˜DelayExchangeäº¤æ¢æœº

åŸºäºæ³¨è§£æ–¹å¼ï¼ˆæ¨èï¼‰ï¼š

![image-20210718193747649](../assets/md-img/RabbitMQ.assets/image-20210718193747649.png)

ä¹Ÿå¯ä»¥åŸºäº@Beançš„æ–¹å¼ï¼š

![image-20210718193831076](../assets/md-img/RabbitMQ.assets/image-20210718193831076.png)



#### å‘é€æ¶ˆæ¯

å‘é€æ¶ˆæ¯æ—¶ï¼Œä¸€å®šè¦æºå¸¦x-delayå±æ€§ï¼ŒæŒ‡å®šå»¶è¿Ÿçš„æ—¶é—´ï¼š

![image-20210718193917009](../assets/md-img/RabbitMQ.assets/image-20210718193917009.png)



æ€»ç»“

å»¶è¿Ÿé˜Ÿåˆ—æ’ä»¶çš„ä½¿ç”¨æ­¥éª¤åŒ…æ‹¬å“ªäº›ï¼Ÿ

â€¢å£°æ˜ä¸€ä¸ªäº¤æ¢æœºï¼Œæ·»åŠ delayedå±æ€§ä¸ºtrue

â€¢å‘é€æ¶ˆæ¯æ—¶ï¼Œæ·»åŠ x-delayå¤´ï¼Œå€¼ä¸ºè¶…æ—¶æ—¶é—´





<hr>





## æƒ°æ€§é˜Ÿåˆ—

### æ¶ˆæ¯å †ç§¯é—®é¢˜

å½“ç”Ÿäº§è€…å‘é€æ¶ˆæ¯çš„é€Ÿåº¦è¶…è¿‡äº†æ¶ˆè´¹è€…å¤„ç†æ¶ˆæ¯çš„é€Ÿåº¦ï¼Œå°±ä¼šå¯¼è‡´é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯å †ç§¯ï¼Œç›´åˆ°é˜Ÿåˆ—å­˜å‚¨æ¶ˆæ¯è¾¾åˆ°ä¸Šé™ã€‚ä¹‹åå‘é€çš„æ¶ˆæ¯å°±ä¼šæˆä¸ºæ­»ä¿¡ï¼Œå¯èƒ½ä¼šè¢«ä¸¢å¼ƒï¼Œè¿™å°±æ˜¯æ¶ˆæ¯å †ç§¯é—®é¢˜ã€‚



![image-20210718194040498](../assets/md-img/RabbitMQ.assets/image-20210718194040498.png)





è§£å†³æ¶ˆæ¯å †ç§¯æœ‰ä¸¤ç§æ€è·¯ï¼š

- å¢åŠ æ›´å¤šæ¶ˆè´¹è€…ï¼Œæé«˜æ¶ˆè´¹é€Ÿåº¦ã€‚ä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¹‹å‰è¯´çš„work queueæ¨¡å¼
- æ‰©å¤§é˜Ÿåˆ—å®¹ç§¯ï¼Œæé«˜å †ç§¯ä¸Šé™



è¦æå‡é˜Ÿåˆ—å®¹ç§¯ï¼ŒæŠŠæ¶ˆæ¯ä¿å­˜åœ¨å†…å­˜ä¸­æ˜¾ç„¶æ˜¯ä¸è¡Œçš„ã€‚



### æƒ°æ€§é˜Ÿåˆ—

ä»RabbitMQçš„3.6.0ç‰ˆæœ¬å¼€å§‹ï¼Œå°±å¢åŠ äº†Lazy Queuesçš„æ¦‚å¿µï¼Œä¹Ÿå°±æ˜¯æƒ°æ€§é˜Ÿåˆ—ã€‚æƒ°æ€§é˜Ÿåˆ—çš„ç‰¹å¾å¦‚ä¸‹ï¼š

- æ¥æ”¶åˆ°æ¶ˆæ¯åç›´æ¥å­˜å…¥ç£ç›˜è€Œéå†…å­˜
- æ¶ˆè´¹è€…è¦æ¶ˆè´¹æ¶ˆæ¯æ—¶æ‰ä¼šä»ç£ç›˜ä¸­è¯»å–å¹¶åŠ è½½åˆ°å†…å­˜
- æ”¯æŒæ•°ç™¾ä¸‡æ¡çš„æ¶ˆæ¯å­˜å‚¨



### åŸºäºå‘½ä»¤è¡Œè®¾ç½®lazy-queue

è€Œè¦è®¾ç½®ä¸€ä¸ªé˜Ÿåˆ—ä¸ºæƒ°æ€§é˜Ÿåˆ—ï¼Œåªéœ€è¦åœ¨å£°æ˜é˜Ÿåˆ—æ—¶ï¼ŒæŒ‡å®šx-queue-modeå±æ€§ä¸ºlazyå³å¯ã€‚å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œå°†ä¸€ä¸ªè¿è¡Œä¸­çš„é˜Ÿåˆ—ä¿®æ”¹ä¸ºæƒ°æ€§é˜Ÿåˆ—ï¼š

```sh
rabbitmqctl set_policy Lazy "^lazy-queue$" '{"queue-mode":"lazy"}' --apply-to queues  
```

å‘½ä»¤è§£è¯»ï¼š

- `rabbitmqctl` ï¼šRabbitMQçš„å‘½ä»¤è¡Œå·¥å…·
- `set_policy` ï¼šæ·»åŠ ä¸€ä¸ªç­–ç•¥
- `Lazy` ï¼šç­–ç•¥åç§°ï¼Œå¯ä»¥è‡ªå®šä¹‰
- `"^lazy-queue$"` ï¼šç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…é˜Ÿåˆ—çš„åå­—
- `'{"queue-mode":"lazy"}'` ï¼šè®¾ç½®é˜Ÿåˆ—æ¨¡å¼ä¸ºlazyæ¨¡å¼
- `--apply-to queues  `ï¼šç­–ç•¥çš„ä½œç”¨å¯¹è±¡ï¼Œæ˜¯æ‰€æœ‰çš„é˜Ÿåˆ—



### åŸºäº@Beanå£°æ˜lazy-queue

![image-20210718194522223](../assets/md-img/RabbitMQ.assets/image-20210718194522223.png)

### åŸºäº@RabbitListenerå£°æ˜LazyQueue

![image-20210718194539054](../assets/md-img/RabbitMQ.assets/image-20210718194539054.png)





### æ€»ç»“

æ¶ˆæ¯å †ç§¯é—®é¢˜çš„è§£å†³æ–¹æ¡ˆï¼Ÿ

- é˜Ÿåˆ—ä¸Šç»‘å®šå¤šä¸ªæ¶ˆè´¹è€…ï¼Œæé«˜æ¶ˆè´¹é€Ÿåº¦
- ä½¿ç”¨æƒ°æ€§é˜Ÿåˆ—ï¼Œå¯ä»¥å†mqä¸­ä¿å­˜æ›´å¤šæ¶ˆæ¯

æƒ°æ€§é˜Ÿåˆ—çš„ä¼˜ç‚¹æœ‰å“ªäº›ï¼Ÿ

- åŸºäºç£ç›˜å­˜å‚¨ï¼Œæ¶ˆæ¯ä¸Šé™é«˜
- æ²¡æœ‰é—´æ­‡æ€§çš„page-outï¼Œæ€§èƒ½æ¯”è¾ƒç¨³å®š

æƒ°æ€§é˜Ÿåˆ—çš„ç¼ºç‚¹æœ‰å“ªäº›ï¼Ÿ

- åŸºäºç£ç›˜å­˜å‚¨ï¼Œæ¶ˆæ¯æ—¶æ•ˆæ€§ä¼šé™ä½
- æ€§èƒ½å—é™äºç£ç›˜çš„IO



<hr>







## é›†ç¾¤éƒ¨ç½²

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹çœ‹å¦‚ä½•å®‰è£…RabbitMQçš„é›†ç¾¤ã€‚

### é›†ç¾¤åˆ†ç±»

åœ¨RabbitMQçš„å®˜æ–¹æ–‡æ¡£ä¸­ï¼Œè®²è¿°äº†ä¸¤ç§é›†ç¾¤çš„é…ç½®æ–¹å¼ï¼š

- æ™®é€šæ¨¡å¼ï¼šæ™®é€šæ¨¡å¼é›†ç¾¤ä¸è¿›è¡Œæ•°æ®åŒæ­¥ï¼Œæ¯ä¸ªMQéƒ½æœ‰è‡ªå·±çš„é˜Ÿåˆ—ã€æ•°æ®ä¿¡æ¯ï¼ˆå…¶å®ƒå…ƒæ•°æ®ä¿¡æ¯å¦‚äº¤æ¢æœºç­‰ä¼šåŒæ­¥ï¼‰ã€‚ä¾‹å¦‚æˆ‘ä»¬æœ‰2ä¸ªMQï¼šmq1ï¼Œå’Œmq2ï¼Œå¦‚æœä½ çš„æ¶ˆæ¯åœ¨mq1ï¼Œè€Œä½ è¿æ¥åˆ°äº†mq2ï¼Œé‚£ä¹ˆmq2ä¼šå»mq1æ‹‰å–æ¶ˆæ¯ï¼Œç„¶åè¿”å›ç»™ä½ ã€‚å¦‚æœmq1å®•æœºï¼Œæ¶ˆæ¯å°±ä¼šä¸¢å¤±ã€‚
- é•œåƒæ¨¡å¼ï¼šä¸æ™®é€šæ¨¡å¼ä¸åŒï¼Œé˜Ÿåˆ—ä¼šåœ¨å„ä¸ªmqçš„é•œåƒèŠ‚ç‚¹ä¹‹é—´åŒæ­¥ï¼Œå› æ­¤ä½ è¿æ¥åˆ°ä»»ä½•ä¸€ä¸ªé•œåƒèŠ‚ç‚¹ï¼Œå‡å¯è·å–åˆ°æ¶ˆæ¯ã€‚è€Œä¸”å¦‚æœä¸€ä¸ªèŠ‚ç‚¹å®•æœºï¼Œå¹¶ä¸ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚ä¸è¿‡ï¼Œè¿™ç§æ–¹å¼å¢åŠ äº†æ•°æ®åŒæ­¥çš„å¸¦å®½æ¶ˆè€—ã€‚



æˆ‘ä»¬å…ˆæ¥çœ‹æ™®é€šæ¨¡å¼é›†ç¾¤ï¼Œæˆ‘ä»¬çš„è®¡åˆ’éƒ¨ç½²3èŠ‚ç‚¹çš„mqé›†ç¾¤ï¼š

| ä¸»æœºå | æ§åˆ¶å°ç«¯å£      | amqpé€šä¿¡ç«¯å£    |
| ------ | --------------- | --------------- |
| mq1    | 8081 ---> 15672 | 8071 ---> 5672  |
| mq2    | 8082 ---> 15672 | 8072 ---> 5672  |
| mq3    | 8083 ---> 15672 | 8073  ---> 5672 |



é›†ç¾¤ä¸­çš„èŠ‚ç‚¹æ ‡ç¤ºé»˜è®¤éƒ½æ˜¯ï¼š`rabbit@[hostname]`ï¼Œå› æ­¤ä»¥ä¸Šä¸‰ä¸ªèŠ‚ç‚¹çš„åç§°åˆ†åˆ«ä¸ºï¼š

- rabbit@mq1
- rabbit@mq2
- rabbit@mq3



### è·å–cookie

RabbitMQåº•å±‚ä¾èµ–äºErlangï¼Œè€ŒErlangè™šæ‹Ÿæœºå°±æ˜¯ä¸€ä¸ªé¢å‘åˆ†å¸ƒå¼çš„è¯­è¨€ï¼Œé»˜è®¤å°±æ”¯æŒé›†ç¾¤æ¨¡å¼ã€‚é›†ç¾¤æ¨¡å¼ä¸­çš„æ¯ä¸ªRabbitMQ èŠ‚ç‚¹ä½¿ç”¨ cookie æ¥ç¡®å®šå®ƒä»¬æ˜¯å¦è¢«å…è®¸ç›¸äº’é€šä¿¡ã€‚

è¦ä½¿ä¸¤ä¸ªèŠ‚ç‚¹èƒ½å¤Ÿé€šä¿¡ï¼Œå®ƒä»¬å¿…é¡»å…·æœ‰ç›¸åŒçš„å…±äº«ç§˜å¯†ï¼Œç§°ä¸º**Erlang cookie**ã€‚cookie åªæ˜¯ä¸€ä¸²æœ€å¤š 255 ä¸ªå­—ç¬¦çš„å­—æ¯æ•°å­—å­—ç¬¦ã€‚

æ¯ä¸ªé›†ç¾¤èŠ‚ç‚¹å¿…é¡»å…·æœ‰**ç›¸åŒçš„ cookie**ã€‚å®ä¾‹ä¹‹é—´ä¹Ÿéœ€è¦å®ƒæ¥ç›¸äº’é€šä¿¡ã€‚



æˆ‘ä»¬å…ˆåœ¨ä¹‹å‰å¯åŠ¨çš„mqå®¹å™¨ä¸­è·å–ä¸€ä¸ªcookieå€¼ï¼Œä½œä¸ºé›†ç¾¤çš„cookieã€‚æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š

```sh
docker exec -it mq cat /var/lib/rabbitmq/.erlang.cookie
```

å¯ä»¥çœ‹åˆ°cookieå€¼å¦‚ä¸‹ï¼š

```sh
FXZMCVGLBIXZCDEMMVZQ
```



æ¥ä¸‹æ¥ï¼Œåœæ­¢å¹¶åˆ é™¤å½“å‰çš„mqå®¹å™¨ï¼Œæˆ‘ä»¬é‡æ–°æ­å»ºé›†ç¾¤ã€‚

```sh
docker rm -f mq
```



![image-20210717212345165](../assets/md-img/RabbitMQ.assets/image-20210717212345165.png)



### å‡†å¤‡é›†ç¾¤é…ç½®

åœ¨/tmpç›®å½•æ–°å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶ rabbitmq.confï¼š

```sh
cd /tmp
# åˆ›å»ºæ–‡ä»¶
touch rabbitmq.conf
```

æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š

```nginx
loopback_users.guest = false
listeners.tcp.default = 5672
cluster_formation.peer_discovery_backend = rabbit_peer_discovery_classic_config
cluster_formation.classic_config.nodes.1 = rabbit@mq1
cluster_formation.classic_config.nodes.2 = rabbit@mq2
cluster_formation.classic_config.nodes.3 = rabbit@mq3
```



å†åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œè®°å½•cookie

```sh
cd /tmp
# åˆ›å»ºcookieæ–‡ä»¶
touch .erlang.cookie
# å†™å…¥cookie
echo "FXZMCVGLBIXZCDEMMVZQ" > .erlang.cookie
# ä¿®æ”¹cookieæ–‡ä»¶çš„æƒé™
chmod 600 .erlang.cookie
```





å‡†å¤‡ä¸‰ä¸ªç›®å½•,mq1ã€mq2ã€mq3ï¼š

```sh
cd /tmp
# åˆ›å»ºç›®å½•
mkdir mq1 mq2 mq3
```



ç„¶åæ‹·è´rabbitmq.confã€cookieæ–‡ä»¶åˆ°mq1ã€mq2ã€mq3ï¼š

```sh
# è¿›å…¥/tmp
cd /tmp
# æ‹·è´
cp rabbitmq.conf mq1
cp rabbitmq.conf mq2
cp rabbitmq.conf mq3
cp .erlang.cookie mq1
cp .erlang.cookie mq2
cp .erlang.cookie mq3
```





### å¯åŠ¨é›†ç¾¤

åˆ›å»ºä¸€ä¸ªç½‘ç»œï¼š

```sh
docker network create mq-net
```



docker volume create 



è¿è¡Œå‘½ä»¤

```sh
docker run -d --net mq-net \
-v ${PWD}/mq1/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf \
-v ${PWD}/.erlang.cookie:/var/lib/rabbitmq/.erlang.cookie \
-e RABBITMQ_DEFAULT_USER=itcast \
-e RABBITMQ_DEFAULT_PASS=123321 \
--name mq1 \
--hostname mq1 \
-p 8071:5672 \
-p 8081:15672 \
rabbitmq:3.8-management
```



```sh
docker run -d --net mq-net \
-v ${PWD}/mq2/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf \
-v ${PWD}/.erlang.cookie:/var/lib/rabbitmq/.erlang.cookie \
-e RABBITMQ_DEFAULT_USER=itcast \
-e RABBITMQ_DEFAULT_PASS=123321 \
--name mq2 \
--hostname mq2 \
-p 8072:5672 \
-p 8082:15672 \
rabbitmq:3.8-management
```



```sh
docker run -d --net mq-net \
-v ${PWD}/mq3/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf \
-v ${PWD}/.erlang.cookie:/var/lib/rabbitmq/.erlang.cookie \
-e RABBITMQ_DEFAULT_USER=itcast \
-e RABBITMQ_DEFAULT_PASS=123321 \
--name mq3 \
--hostname mq3 \
-p 8073:5672 \
-p 8083:15672 \
rabbitmq:3.8-management
```



### æµ‹è¯•

åœ¨mq1è¿™ä¸ªèŠ‚ç‚¹ä¸Šæ·»åŠ ä¸€ä¸ªé˜Ÿåˆ—ï¼š

![image-20210717222833196](../assets/md-img/RabbitMQ.assets/image-20210717222833196.png)

å¦‚å›¾ï¼Œåœ¨mq2å’Œmq3ä¸¤ä¸ªæ§åˆ¶å°ä¹Ÿéƒ½èƒ½çœ‹åˆ°ï¼š

![image-20210717223057902](../assets/md-img/RabbitMQ.assets/image-20210717223057902.png)



### æ•°æ®å…±äº«æµ‹è¯•

ç‚¹å‡»è¿™ä¸ªé˜Ÿåˆ—ï¼Œè¿›å…¥ç®¡ç†é¡µé¢ï¼š

![image-20210717223421750](../assets/md-img/RabbitMQ.assets/image-20210717223421750.png)

ç„¶ååˆ©ç”¨æ§åˆ¶å°å‘é€ä¸€æ¡æ¶ˆæ¯åˆ°è¿™ä¸ªé˜Ÿåˆ—ï¼š

![image-20210717223320238](../assets/md-img/RabbitMQ.assets/image-20210717223320238.png)



ç»“æœåœ¨mq2ã€mq3ä¸Šéƒ½èƒ½çœ‹åˆ°è¿™æ¡æ¶ˆæ¯ï¼š

![image-20210717223603628](../assets/md-img/RabbitMQ.assets/image-20210717223603628.png)





### å¯ç”¨æ€§æµ‹è¯•

æˆ‘ä»¬è®©å…¶ä¸­ä¸€å°èŠ‚ç‚¹mq1å®•æœºï¼š

```sh
docker stop mq1
```

ç„¶åç™»å½•mq2æˆ–mq3çš„æ§åˆ¶å°ï¼Œå‘ç°simple.queueä¹Ÿä¸å¯ç”¨äº†ï¼š

![image-20210717223800203](../assets/md-img/RabbitMQ.assets/image-20210717223800203.png)



è¯´æ˜æ•°æ®å¹¶æ²¡æœ‰æ‹·è´åˆ°mq2å’Œmq3ã€‚





## é•œåƒæ¨¡å¼

åœ¨åˆšåˆšçš„æ¡ˆä¾‹ä¸­ï¼Œä¸€æ—¦åˆ›å»ºé˜Ÿåˆ—çš„ä¸»æœºå®•æœºï¼Œé˜Ÿåˆ—å°±ä¼šä¸å¯ç”¨ã€‚ä¸å…·å¤‡é«˜å¯ç”¨èƒ½åŠ›ã€‚å¦‚æœè¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¿…é¡»ä½¿ç”¨å®˜æ–¹æä¾›çš„é•œåƒé›†ç¾¤æ–¹æ¡ˆã€‚

å®˜æ–¹æ–‡æ¡£åœ°å€ï¼šhttps://www.rabbitmq.com/ha.html



### é•œåƒæ¨¡å¼çš„ç‰¹å¾

é»˜è®¤æƒ…å†µä¸‹ï¼Œé˜Ÿåˆ—åªä¿å­˜åœ¨åˆ›å»ºè¯¥é˜Ÿåˆ—çš„èŠ‚ç‚¹ä¸Šã€‚è€Œé•œåƒæ¨¡å¼ä¸‹ï¼Œåˆ›å»ºé˜Ÿåˆ—çš„èŠ‚ç‚¹è¢«ç§°ä¸ºè¯¥é˜Ÿåˆ—çš„**ä¸»èŠ‚ç‚¹**ï¼Œé˜Ÿåˆ—è¿˜ä¼šæ‹·è´åˆ°é›†ç¾¤ä¸­çš„å…¶å®ƒèŠ‚ç‚¹ï¼Œä¹Ÿå«åšè¯¥é˜Ÿåˆ—çš„**é•œåƒ**èŠ‚ç‚¹ã€‚

ä½†æ˜¯ï¼Œä¸åŒé˜Ÿåˆ—å¯ä»¥åœ¨é›†ç¾¤ä¸­çš„ä»»æ„èŠ‚ç‚¹ä¸Šåˆ›å»ºï¼Œå› æ­¤ä¸åŒé˜Ÿåˆ—çš„ä¸»èŠ‚ç‚¹å¯ä»¥ä¸åŒã€‚ç”šè‡³ï¼Œ**ä¸€ä¸ªé˜Ÿåˆ—çš„ä¸»èŠ‚ç‚¹å¯èƒ½æ˜¯å¦ä¸€ä¸ªé˜Ÿåˆ—çš„é•œåƒèŠ‚ç‚¹**ã€‚

ç”¨æˆ·å‘é€ç»™é˜Ÿåˆ—çš„ä¸€åˆ‡è¯·æ±‚ï¼Œä¾‹å¦‚å‘é€æ¶ˆæ¯ã€æ¶ˆæ¯å›æ‰§é»˜è®¤éƒ½ä¼šåœ¨ä¸»èŠ‚ç‚¹å®Œæˆï¼Œå¦‚æœæ˜¯ä»èŠ‚ç‚¹æ¥æ”¶åˆ°è¯·æ±‚ï¼Œä¹Ÿä¼šè·¯ç”±åˆ°ä¸»èŠ‚ç‚¹å»å®Œæˆã€‚**é•œåƒèŠ‚ç‚¹ä»…ä»…èµ·åˆ°å¤‡ä»½æ•°æ®ä½œç”¨**ã€‚

å½“ä¸»èŠ‚ç‚¹æ¥æ”¶åˆ°æ¶ˆè´¹è€…çš„ACKæ—¶ï¼Œæ‰€æœ‰é•œåƒéƒ½ä¼šåˆ é™¤èŠ‚ç‚¹ä¸­çš„æ•°æ®ã€‚



æ€»ç»“å¦‚ä¸‹ï¼š

- é•œåƒé˜Ÿåˆ—ç»“æ„æ˜¯ä¸€ä¸»å¤šä»ï¼ˆä»å°±æ˜¯é•œåƒï¼‰
- æ‰€æœ‰æ“ä½œéƒ½æ˜¯ä¸»èŠ‚ç‚¹å®Œæˆï¼Œç„¶ååŒæ­¥ç»™é•œåƒèŠ‚ç‚¹
- ä¸»å®•æœºåï¼Œé•œåƒèŠ‚ç‚¹ä¼šæ›¿ä»£æˆæ–°çš„ä¸»ï¼ˆå¦‚æœåœ¨ä¸»ä»åŒæ­¥å®Œæˆå‰ï¼Œä¸»å°±å·²ç»å®•æœºï¼Œå¯èƒ½å‡ºç°æ•°æ®ä¸¢å¤±ï¼‰
- ä¸å…·å¤‡è´Ÿè½½å‡è¡¡åŠŸèƒ½ï¼Œå› ä¸ºæ‰€æœ‰æ“ä½œéƒ½ä¼šæœ‰ä¸»èŠ‚ç‚¹å®Œæˆï¼ˆä½†æ˜¯ä¸åŒé˜Ÿåˆ—ï¼Œå…¶ä¸»èŠ‚ç‚¹å¯ä»¥ä¸åŒï¼Œå¯ä»¥åˆ©ç”¨è¿™ä¸ªæé«˜ååé‡ï¼‰



### é•œåƒæ¨¡å¼çš„é…ç½®

é•œåƒæ¨¡å¼çš„é…ç½®æœ‰3ç§æ¨¡å¼ï¼š

| ha-mode         | ha-params         | æ•ˆæœ                                                         |
| :-------------- | :---------------- | :----------------------------------------------------------- |
| å‡†ç¡®æ¨¡å¼exactly | é˜Ÿåˆ—çš„å‰¯æœ¬é‡count | é›†ç¾¤ä¸­é˜Ÿåˆ—å‰¯æœ¬ï¼ˆä¸»æœåŠ¡å™¨å’Œé•œåƒæœåŠ¡å™¨ä¹‹å’Œï¼‰çš„æ•°é‡ã€‚countå¦‚æœä¸º1æ„å‘³ç€å•ä¸ªå‰¯æœ¬ï¼šå³é˜Ÿåˆ—ä¸»èŠ‚ç‚¹ã€‚countå€¼ä¸º2è¡¨ç¤º2ä¸ªå‰¯æœ¬ï¼š1ä¸ªé˜Ÿåˆ—ä¸»å’Œ1ä¸ªé˜Ÿåˆ—é•œåƒã€‚æ¢å¥è¯è¯´ï¼šcount = é•œåƒæ•°é‡ + 1ã€‚å¦‚æœç¾¤é›†ä¸­çš„èŠ‚ç‚¹æ•°å°‘äºcountï¼Œåˆ™è¯¥é˜Ÿåˆ—å°†é•œåƒåˆ°æ‰€æœ‰èŠ‚ç‚¹ã€‚å¦‚æœæœ‰é›†ç¾¤æ€»æ•°å¤§äºcount+1ï¼Œå¹¶ä¸”åŒ…å«é•œåƒçš„èŠ‚ç‚¹å‡ºç°æ•…éšœï¼Œåˆ™å°†åœ¨å¦ä¸€ä¸ªèŠ‚ç‚¹ä¸Šåˆ›å»ºä¸€ä¸ªæ–°çš„é•œåƒã€‚ |
| all             | (none)            | é˜Ÿåˆ—åœ¨ç¾¤é›†ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ä¹‹é—´è¿›è¡Œé•œåƒã€‚é˜Ÿåˆ—å°†é•œåƒåˆ°ä»»ä½•æ–°åŠ å…¥çš„èŠ‚ç‚¹ã€‚é•œåƒåˆ°æ‰€æœ‰èŠ‚ç‚¹å°†å¯¹æ‰€æœ‰ç¾¤é›†èŠ‚ç‚¹æ–½åŠ é¢å¤–çš„å‹åŠ›ï¼ŒåŒ…æ‹¬ç½‘ç»œI / Oï¼Œç£ç›˜I / Oå’Œç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µã€‚æ¨èä½¿ç”¨exactlyï¼Œè®¾ç½®å‰¯æœ¬æ•°ä¸ºï¼ˆN / 2 +1ï¼‰ã€‚ |
| nodes           | *node names*      | æŒ‡å®šé˜Ÿåˆ—åˆ›å»ºåˆ°å“ªäº›èŠ‚ç‚¹ï¼Œå¦‚æœæŒ‡å®šçš„èŠ‚ç‚¹å…¨éƒ¨ä¸å­˜åœ¨ï¼Œåˆ™ä¼šå‡ºç°å¼‚å¸¸ã€‚å¦‚æœæŒ‡å®šçš„èŠ‚ç‚¹åœ¨é›†ç¾¤ä¸­å­˜åœ¨ï¼Œä½†æ˜¯æš‚æ—¶ä¸å¯ç”¨ï¼Œä¼šåˆ›å»ºèŠ‚ç‚¹åˆ°å½“å‰å®¢æˆ·ç«¯è¿æ¥åˆ°çš„èŠ‚ç‚¹ã€‚ |

è¿™é‡Œæˆ‘ä»¬ä»¥rabbitmqctlå‘½ä»¤ä½œä¸ºæ¡ˆä¾‹æ¥è®²è§£é…ç½®è¯­æ³•ã€‚

è¯­æ³•ç¤ºä¾‹ï¼š

### exactlyæ¨¡å¼

```
rabbitmqctl set_policy ha-two "^two\." '{"ha-mode":"exactly","ha-params":2,"ha-sync-mode":"automatic"}'
```

- `rabbitmqctl set_policy`ï¼šå›ºå®šå†™æ³•
- `ha-two`ï¼šç­–ç•¥åç§°ï¼Œè‡ªå®šä¹‰
- `"^two\."`ï¼šåŒ¹é…é˜Ÿåˆ—çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œç¬¦åˆå‘½åè§„åˆ™çš„é˜Ÿåˆ—æ‰ç”Ÿæ•ˆï¼Œè¿™é‡Œæ˜¯ä»»ä½•ä»¥`two.`å¼€å¤´çš„é˜Ÿåˆ—åç§°
- `'{"ha-mode":"exactly","ha-params":2,"ha-sync-mode":"automatic"}'`: ç­–ç•¥å†…å®¹
  - `"ha-mode":"exactly"`ï¼šç­–ç•¥æ¨¡å¼ï¼Œæ­¤å¤„æ˜¯exactlyæ¨¡å¼ï¼ŒæŒ‡å®šå‰¯æœ¬æ•°é‡
  - `"ha-params":2`ï¼šç­–ç•¥å‚æ•°ï¼Œè¿™é‡Œæ˜¯2ï¼Œå°±æ˜¯å‰¯æœ¬æ•°é‡ä¸º2ï¼Œ1ä¸»1é•œåƒ
  - `"ha-sync-mode":"automatic"`ï¼šåŒæ­¥ç­–ç•¥ï¼Œé»˜è®¤æ˜¯manualï¼Œå³æ–°åŠ å…¥çš„é•œåƒèŠ‚ç‚¹ä¸ä¼šåŒæ­¥æ—§çš„æ¶ˆæ¯ã€‚å¦‚æœè®¾ç½®ä¸ºautomaticï¼Œåˆ™æ–°åŠ å…¥çš„é•œåƒèŠ‚ç‚¹ä¼šæŠŠä¸»èŠ‚ç‚¹ä¸­æ‰€æœ‰æ¶ˆæ¯éƒ½åŒæ­¥ï¼Œä¼šå¸¦æ¥é¢å¤–çš„ç½‘ç»œå¼€é”€

### allæ¨¡å¼

```
rabbitmqctl set_policy ha-all "^all\." '{"ha-mode":"all"}'
```

- `ha-all`ï¼šç­–ç•¥åç§°ï¼Œè‡ªå®šä¹‰
- `"^all\."`ï¼šåŒ¹é…æ‰€æœ‰ä»¥`all.`å¼€å¤´çš„é˜Ÿåˆ—å
- `'{"ha-mode":"all"}'`ï¼šç­–ç•¥å†…å®¹
  - `"ha-mode":"all"`ï¼šç­–ç•¥æ¨¡å¼ï¼Œæ­¤å¤„æ˜¯allæ¨¡å¼ï¼Œå³æ‰€æœ‰èŠ‚ç‚¹éƒ½ä¼šç§°ä¸ºé•œåƒèŠ‚ç‚¹

### nodesæ¨¡å¼

```
rabbitmqctl set_policy ha-nodes "^nodes\." '{"ha-mode":"nodes","ha-params":["rabbit@nodeA", "rabbit@nodeB"]}'
```

- `rabbitmqctl set_policy`ï¼šå›ºå®šå†™æ³•
- `ha-nodes`ï¼šç­–ç•¥åç§°ï¼Œè‡ªå®šä¹‰
- `"^nodes\."`ï¼šåŒ¹é…é˜Ÿåˆ—çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œç¬¦åˆå‘½åè§„åˆ™çš„é˜Ÿåˆ—æ‰ç”Ÿæ•ˆï¼Œè¿™é‡Œæ˜¯ä»»ä½•ä»¥`nodes.`å¼€å¤´çš„é˜Ÿåˆ—åç§°
- `'{"ha-mode":"nodes","ha-params":["rabbit@nodeA", "rabbit@nodeB"]}'`: ç­–ç•¥å†…å®¹
  - `"ha-mode":"nodes"`ï¼šç­–ç•¥æ¨¡å¼ï¼Œæ­¤å¤„æ˜¯nodesæ¨¡å¼
  - `"ha-params":["rabbit@mq1", "rabbit@mq2"]`ï¼šç­–ç•¥å‚æ•°ï¼Œè¿™é‡ŒæŒ‡å®šå‰¯æœ¬æ‰€åœ¨èŠ‚ç‚¹åç§°



### æµ‹è¯•

æˆ‘ä»¬ä½¿ç”¨exactlyæ¨¡å¼çš„é•œåƒï¼Œå› ä¸ºé›†ç¾¤èŠ‚ç‚¹æ•°é‡ä¸º3ï¼Œå› æ­¤é•œåƒæ•°é‡å°±è®¾ç½®ä¸º2.



è¿è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š

```sh
docker exec -it mq1 rabbitmqctl set_policy ha-two "^two\." '{"ha-mode":"exactly","ha-params":2,"ha-sync-mode":"automatic"}'
```



ä¸‹é¢ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„é˜Ÿåˆ—ï¼š

![image-20210717231751411](../assets/md-img/RabbitMQ.assets/image-20210717231751411.png)



åœ¨ä»»æ„ä¸€ä¸ªmqæ§åˆ¶å°æŸ¥çœ‹é˜Ÿåˆ—ï¼š

![image-20210717231829505](../assets/md-img/RabbitMQ.assets/image-20210717231829505.png)



### æµ‹è¯•æ•°æ®å…±äº«

ç»™two.queueå‘é€ä¸€æ¡æ¶ˆæ¯ï¼š

![image-20210717231958996](../assets/md-img/RabbitMQ.assets/image-20210717231958996.png)



ç„¶ååœ¨mq1ã€mq2ã€mq3çš„ä»»æ„æ§åˆ¶å°æŸ¥çœ‹æ¶ˆæ¯ï¼š

![image-20210717232108584](../assets/md-img/RabbitMQ.assets/image-20210717232108584.png)





### æµ‹è¯•é«˜å¯ç”¨

ç°åœ¨ï¼Œæˆ‘ä»¬è®©two.queueçš„ä¸»èŠ‚ç‚¹mq1å®•æœºï¼š

```sh
docker stop mq1
```



æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ï¼š

![image-20210717232257420](../assets/md-img/RabbitMQ.assets/image-20210717232257420.png)



æŸ¥çœ‹é˜Ÿåˆ—çŠ¶æ€ï¼š

![image-20210717232322646](../assets/md-img/RabbitMQ.assets/image-20210717232322646.png)

å‘ç°ä¾ç„¶æ˜¯å¥åº·çš„ï¼å¹¶ä¸”å…¶ä¸»èŠ‚ç‚¹åˆ‡æ¢åˆ°äº†rabbit@mq2ä¸Š







## ä»²è£é˜Ÿåˆ—

ä»RabbitMQ 3.8ç‰ˆæœ¬å¼€å§‹ï¼Œå¼•å…¥äº†æ–°çš„ä»²è£é˜Ÿåˆ—ï¼Œä»–å…·å¤‡ä¸é•œåƒé˜Ÿé‡Œç±»ä¼¼çš„åŠŸèƒ½ï¼Œä½†ä½¿ç”¨æ›´åŠ æ–¹ä¾¿ã€‚





### æ·»åŠ ä»²è£é˜Ÿåˆ—

åœ¨ä»»æ„æ§åˆ¶å°æ·»åŠ ä¸€ä¸ªé˜Ÿåˆ—ï¼Œä¸€å®šè¦é€‰æ‹©é˜Ÿåˆ—ç±»å‹ä¸ºQuorumç±»å‹ã€‚

![image-20210717234329640](../assets/md-img/RabbitMQ.assets/image-20210717234329640.png)



åœ¨ä»»æ„æ§åˆ¶å°æŸ¥çœ‹é˜Ÿåˆ—ï¼š

![image-20210717234426209](../assets/md-img/RabbitMQ.assets/image-20210717234426209.png)



å¯ä»¥çœ‹åˆ°ï¼Œä»²è£é˜Ÿåˆ—çš„ + 2å­—æ ·ã€‚ä»£è¡¨è¿™ä¸ªé˜Ÿåˆ—æœ‰2ä¸ªé•œåƒèŠ‚ç‚¹ã€‚

å› ä¸ºä»²è£é˜Ÿåˆ—é»˜è®¤çš„é•œåƒæ•°ä¸º5ã€‚å¦‚æœä½ çš„é›†ç¾¤æœ‰7ä¸ªèŠ‚ç‚¹ï¼Œé‚£ä¹ˆé•œåƒæ•°è‚¯å®šæ˜¯5ï¼›è€Œæˆ‘ä»¬é›†ç¾¤åªæœ‰3ä¸ªèŠ‚ç‚¹ï¼Œå› æ­¤é•œåƒæ•°é‡å°±æ˜¯3.



### æµ‹è¯•

å¯ä»¥å‚è€ƒå¯¹é•œåƒé›†ç¾¤çš„æµ‹è¯•ï¼Œæ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚





### é›†ç¾¤æ‰©å®¹

#### åŠ å…¥é›†ç¾¤

1ï¼‰å¯åŠ¨ä¸€ä¸ªæ–°çš„MQå®¹å™¨ï¼š

```sh
docker run -d --net mq-net \
-v ${PWD}/.erlang.cookie:/var/lib/rabbitmq/.erlang.cookie \
-e RABBITMQ_DEFAULT_USER=itcast \
-e RABBITMQ_DEFAULT_PASS=123321 \
--name mq4 \
--hostname mq5 \
-p 8074:15672 \
-p 8084:15672 \
rabbitmq:3.8-management
```

2ï¼‰è¿›å…¥å®¹å™¨æ§åˆ¶å°ï¼š

```sh
docker exec -it mq4 bash
```

3ï¼‰åœæ­¢mqè¿›ç¨‹

```sh
rabbitmqctl stop_app
```



4ï¼‰é‡ç½®RabbitMQä¸­çš„æ•°æ®ï¼š

```sh
rabbitmqctl reset
```



5ï¼‰åŠ å…¥mq1ï¼š

```sh
rabbitmqctl join_cluster rabbit@mq1
```



6ï¼‰å†æ¬¡å¯åŠ¨mqè¿›ç¨‹

```sh
rabbitmqctl start_app
```



![image-20210718001909492](../assets/md-img/RabbitMQ.assets/image-20210718001909492.png)





#### å¢åŠ ä»²è£é˜Ÿåˆ—å‰¯æœ¬

æˆ‘ä»¬å…ˆæŸ¥çœ‹ä¸‹quorum.queueè¿™ä¸ªé˜Ÿåˆ—ç›®å‰çš„å‰¯æœ¬æƒ…å†µï¼Œè¿›å…¥mq1å®¹å™¨ï¼š

```sh
docker exec -it mq1 bash
```

æ‰§è¡Œå‘½ä»¤ï¼š

```sh
rabbitmq-queues quorum_status "quorum.queue"
```

ç»“æœï¼š

![image-20210718002118357](../assets/md-img/RabbitMQ.assets/image-20210718002118357.png)

ç°åœ¨ï¼Œæˆ‘ä»¬è®©mq4ä¹ŸåŠ å…¥è¿›æ¥ï¼š

```sh
rabbitmq-queues add_member "quorum.queue" "rabbit@mq4"
```

ç»“æœï¼š

![image-20210718002253226](../assets/md-img/RabbitMQ.assets/image-20210718002253226.png)



å†æ¬¡æŸ¥çœ‹ï¼š

```sh
rabbitmq-queues quorum_status "quorum.queue"
```

![image-20210718002342603](../assets/md-img/RabbitMQ.assets/image-20210718002342603.png)



æŸ¥çœ‹æ§åˆ¶å°ï¼Œå‘ç°quorum.queueçš„é•œåƒæ•°é‡ä¹Ÿä»åŸæ¥çš„ +2 å˜æˆäº† +3ï¼š

![image-20210718002422365](../assets/md-img/RabbitMQ.assets/image-20210718002422365.png)











